<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>更新指令 - 陰盤奇門足球AI預測系統</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 更新指令專用樣式 */
        .update-header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
        }
        
        .update-title {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .update-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .update-filters {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid #3498db;
        }
        
        .filter-row {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        
        .filter-group {
            flex: 1;
            min-width: 200px;
        }
        
        .updates-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid #2ecc71;
        }
        
        .update-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .update-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }
        
        .update-item.completed {
            border-left-color: #2ecc71;
            background: rgba(46, 204, 113, 0.05);
        }
        
        .update-item.pending {
            border-left-color: #f39c12;
            background: rgba(243, 156, 18, 0.05);
        }
        
        .update-item.failed {
            border-left-color: #e74c3c;
            background: rgba(231, 76, 60, 0.05);
        }
        
        .update-header-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .update-title-section {
            flex: 1;
        }
        
        .update-meta {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 10px;
        }
        
        .update-meta-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.9em;
            color: #7f8c8d;
        }
        
        .update-status {
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 700;
        }
        
        .update-status.completed {
            background: rgba(46, 204, 113, 0.2);
            color: #27ae60;
        }
        
        .update-status.pending {
            background: rgba(243, 156, 18, 0.2);
            color: #d68910;
        }
        
        .update-status.failed {
            background: rgba(231, 76, 60, 0.2);
            color: #c0392b;
        }
        
        .update-content {
            margin-bottom: 20px;
        }
        
        .update-description {
            color: #2c3e50;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        
        .update-changes {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .change-item {
            display: flex;
            align-items: flex-start;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .change-item:last-child {
            border-bottom: none;
        }
        
        .change-icon {
            margin-right: 10px;
            font-size: 1.2em;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .change-added .change-icon {
            color: #2ecc71;
        }
        
        .change-fixed .change-icon {
            color: #3498db;
        }
        
        .change-removed .change-icon {
            color: #e74c3c;
        }
        
        .change-changed .change-icon {
            color: #f39c12;
        }
        
        .change-content {
            color: #2c3e50;
        }
        
        .update-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .action-button {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }
        
        .action-button.primary {
            background: #3498db;
            color: white;
        }
        
        .action-button.primary:hover {
            background: #2980b9;
        }
        
        .action-button.secondary {
            background: #95a5a6;
            color: white;
        }
        
        .action-button.secondary:hover {
            background: #7f8c8d;
        }
        
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid #9b59b6;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.95em;
            color: #7f8c8d;
        }
        
        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.5;
            overflow-x: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }
        
        .empty-state i {
            font-size: 3em;
            margin-bottom: 20px;
            color: #bdc3c7;
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner-large {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.2em;
            color: #2c3e50;
            text-align: center;
        }
        
        @media (max-width: 768px) {
            .update-header-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .update-meta {
                flex-direction: column;
                gap: 5px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .filter-row {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 頂部導航 -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-futbol"></i>
                <span>陰盤奇門足球AI預測系統 V5.2</span>
            </div>
            <div class="nav-menu">
                <a href="index.html"><i class="fas fa-home"></i> 儀表板</a>
                <a href="match_input.html"><i class="fas fa-plus-circle"></i> 輸入比賽</a>
                <a href="analysis_view.html"><i class="fas fa-chart-bar"></i> 分析報告</a>
                <a href="result_verification.html"><i class="fas fa-check-circle"></i> 賽果驗證</a>
                <a href="pattern_library.html"><i class="fas fa-book"></i> 格局庫</a>
                <a href="system_status.html"><i class="fas fa-server"></i> 系統狀態</a>
                <a href="update_instructions.html" class="active"><i class="fas fa-code-branch"></i> 更新指令</a>
            </div>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </nav>

        <!-- 加載遮罩 -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <i class="fas fa-spinner fa-spin loading-spinner-large"></i>
            <div class="loading-text">正在載入更新指令...</div>
        </div>

        <!-- 主內容區 -->
        <main class="main-content">
            <!-- 更新標頭 -->
            <div class="update-header">
                <div class="update-title">
                    <i class="fas fa-code-branch"></i>
                    更新指令管理
                </div>
                <div class="update-subtitle">
                    查看與管理系統更新指令，追蹤版本變更與優化歷史
                </div>
                <div class="report-meta">
                    <div class="meta-item">
                        <i class="fas fa-tag"></i>
                        <span>當前版本：</span>
                        <strong>V5.2</strong>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>最後更新：</span>
                        <strong id="last-update-date">--</strong>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-bolt"></i>
                        <span>待執行：</span>
                        <strong id="pending-updates">--</strong>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-check-circle"></i>
                        <span>已完成：</span>
                        <strong id="completed-updates">--</strong>
                    </div>
                </div>
            </div>

            <!-- 統計卡片 -->
            <div class="stats-card">
                <h3><i class="fas fa-chart-bar"></i> 更新統計</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-updates">--</div>
                        <div class="stat-label">總更新數</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="bug-fixes">--</div>
                        <div class="stat-label">Bug修復</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="features-added">--</div>
                        <div class="stat-label">新功能</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="optimizations">--</div>
                        <div class="stat-label">優化項目</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="success-rate">--%</div>
                        <div class="stat-label">執行成功率</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="avg-duration">--min</div>
                        <div class="stat-label">平均耗時</div>
                    </div>
                </div>
            </div>

            <!-- 過濾器 -->
            <div class="update-filters">
                <h3><i class="fas fa-filter"></i> 篩選更新指令</h3>
                
                <div class="filter-row">
                    <div class="filter-group">
                        <label class="form-label">狀態篩選</label>
                        <select id="status-filter" class="form-control">
                            <option value="">所有狀態</option>
                            <option value="completed">已完成</option>
                            <option value="pending">待執行</option>
                            <option value="failed">執行失敗</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="form-label">類型篩選</label>
                        <select id="type-filter" class="form-control">
                            <option value="">所有類型</option>
                            <option value="bug">Bug修復</option>
                            <option value="feature">新功能</option>
                            <option value="optimization">性能優化</option>
                            <option value="security">安全更新</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label class="form-label">版本篩選</label>
                        <select id="version-filter" class="form-control">
                            <option value="">所有版本</option>
                            <option value="5.2">V5.2</option>
                            <option value="5.1">V5.1</option>
                            <option value="5.0">V5.0</option>
                        </select>
                    </div>
                </div>
                
                <div class="search-box" style="margin-top: 20px;">
                    <input type="text" id="search-updates" class="search-input" placeholder="搜尋更新標題或內容...">
                </div>
                
                <div class="form-actions" style="margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="resetFilters()">
                        <i class="fas fa-undo"></i> 重置篩選
                    </button>
                    <button type="button" class="btn btn-primary" onclick="applyFilters()">
                        <i class="fas fa-filter"></i> 應用篩選
                    </button>
                    <button type="button" class="btn btn-success" onclick="addNewUpdate()">
                        <i class="fas fa-plus-circle"></i> 新增更新
                    </button>
                </div>
            </div>

            <!-- 更新列表 -->
            <div class="updates-container">
                <h3><i class="fas fa-history"></i> 更新指令歷史</h3>
                
                <div id="updates-list">
                    <!-- 動態載入更新項目 -->
                    <div class="empty-state">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>正在載入更新指令...</p>
                    </div>
                </div>
                
                <!-- 分頁控制 -->
                <div class="pagination" id="pagination-controls" style="display: none;">
                    <button class="btn btn-outline" onclick="previousPage()">
                        <i class="fas fa-chevron-left"></i> 上一頁
                    </button>
                    <span class="page-info" id="page-info">第 1 頁，共 1 頁</span>
                    <button class="btn btn-outline" onclick="nextPage()">
                        下一頁 <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
            </div>

            <!-- 快速操作 -->
            <div class="quick-actions">
                <button class="action-btn" onclick="checkForUpdates()">
                    <i class="fas fa-sync-alt"></i>
                    <span>檢查更新</span>
                </button>
                <button class="action-btn" onclick="runPendingUpdates()">
                    <i class="fas fa-play"></i>
                    <span>執行待處理更新</span>
                </button>
                <button class="action-btn" onclick="exportUpdateHistory()">
                    <i class="fas fa-file-export"></i>
                    <span>導出更新歷史</span>
                </button>
                <button class="action-btn" onclick="viewUpdateSchedule()">
                    <i class="fas fa-calendar-alt"></i>
                    <span>查看更新計劃</span>
                </button>
            </div>
        </main>

        <!-- 底部資訊 -->
        <footer class="footer">
            <p>甲方己土玄學顧問公司 · AI陰盤奇門足球分析系統 V5.2</p>
            <p>報告時間：<span id="current-time"></span></p>
        </footer>
    </div>

    <!-- 新增更新模態框 -->
    <div id="add-update-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-plus-circle"></i> 新增更新指令</h3>
                <button class="modal-close" onclick="closeAddUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="update-form">
                    <div class="form-group">
                        <label class="form-label">更新標題 <span class="required">*</span></label>
                        <input type="text" id="update-title" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">更新類型 <span class="required">*</span></label>
                            <select id="update-type" class="form-control" required>
                                <option value="bug">Bug修復</option>
                                <option value="feature">新功能</option>
                                <option value="optimization">性能優化</option>
                                <option value="security">安全更新</option>
                                <option value="documentation">文檔更新</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">目標版本 <span class="required">*</span></label>
                            <select id="update-version" class="form-control" required>
                                <option value="5.2">V5.2</option>
                                <option value="5.3">V5.3</option>
                                <option value="5.4">V5.4</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">更新描述</label>
                        <textarea id="update-description" class="form-control" rows="4" placeholder="詳細描述此次更新的內容..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">變更內容</label>
                        <div class="form-help">
                            <i class="fas fa-info-circle"></i> 每行一個變更，格式：[類型] 描述
                        </div>
                        <textarea id="update-changes" class="form-control" rows="6" placeholder="例如：
[新增] 添加FB3200比賽模板
[修復] 修正奇門引擎參數計算錯誤
[優化] 改進AI預測準確度"></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">優先級</label>
                            <select id="update-priority" class="form-control">
                                <option value="low">低</option>
                                <option value="medium" selected>中</option>
                                <option value="high">高</option>
                                <option value="critical">緊急</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">預計耗時（分鐘）</label>
                            <input type="number" id="update-duration" class="form-control" value="30" min="1">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">相關文件</label>
                        <input type="text" id="update-files" class="form-control" placeholder="用逗號分隔，例如：qimen-engine.js, app.js">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">測試指令</label>
                        <textarea id="update-tests" class="form-control" rows="3" placeholder="更新後需要執行的測試指令..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeAddUpdateModal()">
                    取消
                </button>
                <button type="button" class="btn btn-success" onclick="saveUpdate()">
                    <i class="fas fa-save"></i> 保存更新指令
                </button>
            </div>
        </div>
    </div>

    <!-- 執行更新模態框 -->
    <div id="execute-update-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-play"></i> 執行更新指令</h3>
                <button class="modal-close" onclick="closeExecuteUpdateModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="execute-update-content">
                    正在準備執行更新...
                </div>
                
                <div class="progress-container" style="margin-top: 20px;">
                    <div class="progress-bar" style="height: 10px; background: #ecf0f1; border-radius: 5px;">
                        <div id="update-progress" style="height: 100%; background: #2ecc71; border-radius: 5px; width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                    <div class="progress-text" id="progress-text" style="text-align: center; margin-top: 10px; color: #7f8c8d;">
                        準備中...
                    </div>
                </div>
                
                <div class="log-container" id="update-log" style="margin-top: 20px; max-height: 300px; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9em; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 8px;">
                    <!-- 更新日誌將顯示在這裡 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="cancelUpdate()" id="cancel-update-btn">
                    <i class="fas fa-times"></i> 取消
                </button>
                <button type="button" class="btn btn-primary" onclick="startUpdate()" id="start-update-btn">
                    <i class="fas fa-play"></i> 開始執行
                </button>
            </div>
        </div>
    </div>

    <!-- 腳本 -->
    <script src="js/supabase-client.js"></script>
    <script src="js/app.js"></script>
    <script>
        // 全局變量
        let allUpdates = [];
        let filteredUpdates = [];
        let currentPage = 1;
        const itemsPerPage = 5;
        let currentUpdate = null;
        let updateInterval = null;
        
        // 更新時間顯示
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleString('zh-TW', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }
        
        setInterval(updateTime, 1000);
        updateTime();
        
        // 載入更新指令
        async function loadUpdates() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                // 從本地存儲或檔案載入
                await loadLocalUpdates();
                
                // 更新統計
                updateStatistics();
                
                // 顯示更新
                applyFilters();
                
                // 更新最後更新時間
                const lastUpdate = allUpdates.length > 0 ? 
                    new Date(allUpdates[0].created_at).toLocaleDateString('zh-TW') : '--';
                document.getElementById('last-update-date').textContent = lastUpdate;
                
            } catch (error) {
                console.error('載入更新指令失敗:', error);
                showError('載入更新指令失敗：' + error.message);
                
                // 使用示例更新
                loadExampleUpdates();
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // 從本地存儲載入更新
        async function loadLocalUpdates() {
            try {
                // 從localStorage載入
                const localUpdates = localStorage.getItem('system_updates');
                
                if (localUpdates) {
                    allUpdates = JSON.parse(localUpdates);
                } else {
                    // 從檔案載入
                    const response = await fetch('update_instructions/latest_update.md');
                    if (response.ok) {
                        const markdown = await response.text();
                        allUpdates = parseMarkdownUpdates(markdown);
                        
                        // 保存到本地存儲
                        localStorage.setItem('system_updates', JSON.stringify(allUpdates));
                    } else {
                        throw new Error('更新指令檔案不存在');
                    }
                }
            } catch (error) {
                throw error;
            }
        }
        
        // 解析Markdown格式的更新指令
        function parseMarkdownUpdates(markdown) {
            const updates = [];
            const lines = markdown.split('\n');
            let currentUpdate = null;
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (line.startsWith('## ')) {
                    // 新更新項目
                    if (currentUpdate) {
                        updates.push(currentUpdate);
                    }
                    
                    const title = line.substring(3).trim();
                    currentUpdate = {
                        id: 'update_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                        title: title,
                        type: 'optimization',
                        version: '5.2',
                        status: 'completed',
                        description: '',
                        changes: [],
                        created_at: new Date().toISOString(),
                        executed_at: new Date().toISOString(),
                        duration: 30,
                        priority: 'medium'
                    };
                } else if (line.startsWith('**版本：**') && currentUpdate) {
                    currentUpdate.version = line.substring(5).replace('**', '').trim();
                } else if (line.startsWith('**狀態：**') && currentUpdate) {
                    const status = line.substring(5).replace('**', '').trim();
                    currentUpdate.status = status === '已完成' ? 'completed' : 
                                         status === '執行中' ? 'pending' : 'failed';
                } else if (line.startsWith('**類型：**') && currentUpdate) {
                    const type = line.substring(5).replace('**', '').trim();
                    currentUpdate.type = type === 'Bug修復' ? 'bug' :
                                       type === '新功能' ? 'feature' :
                                       type === '性能優化' ? 'optimization' :
                                       type === '安全更新' ? 'security' : 'documentation';
                } else if (line.startsWith('**描述：**') && currentUpdate) {
                    currentUpdate.description = line.substring(5).replace('**', '').trim();
                } else if (line.startsWith('- [新增]') || line.startsWith('- [修復]') || 
                           line.startsWith('- [優化]') || line.startsWith('- [移除]')) {
                    if (currentUpdate) {
                        const changeType = line.substring(3, 6);
                        const changeContent = line.substring(7).trim();
                        currentUpdate.changes.push({
                            type: changeType === '[新增]' ? 'added' :
                                 changeType === '[修復]' ? 'fixed' :
                                 changeType === '[優化]' ? 'changed' : 'removed',
                            content: changeContent
                        });
                    }
                } else if (line.startsWith('**執行時間：**') && currentUpdate) {
                    const timeStr = line.substring(7).replace('**', '').trim();
                    currentUpdate.duration = parseInt(timeStr.replace('分鐘', '')) || 30;
                }
            }
            
            // 添加最後一個更新
            if (currentUpdate) {
                updates.push(currentUpdate);
            }
            
            return updates;
        }
        
        // 載入示例更新
        function loadExampleUpdates() {
            allUpdates = [
                {
                    id: 'update_1',
                    title: 'FB3200比賽模板集成',
                    type: 'feature',
                    version: '5.2',
                    status: 'completed',
                    description: '集成FB3200比賽模板，優化奇門格局分析算法',
                    changes: [
                        { type: 'added', content: '添加FB3200比賽完整模板' },
                        { type: 'fixed', content: '修正兌宮空亡分析邏輯' },
                        { type: 'optimization', content: '優化三維參數體系計算效率' }
                    ],
                    created_at: '2026-02-10T10:30:00Z',
                    executed_at: '2026-02-10T11:00:00Z',
                    duration: 30,
                    priority: 'high'
                },
                {
                    id: 'update_2',
                    title: 'AI參數V5.2優化',
                    type: 'optimization',
                    version: '5.2',
                    status: 'completed',
                    description: '基於FB3079賽後驗證結果優化AI參數',
                    changes: [
                        { type: 'optimization', content: '死門門迫控球影響從-0.10調整為-0.25' },
                        { type: 'optimization', content: '九天吉神進攻增強從+0.30調整為+0.50' },
                        { type: 'optimization', content: '黃牌算法重建，準確度提升至82%' }
                    ],
                    created_at: '2026-02-09T14:15:00Z',
                    executed_at: '2026-02-09T14:45:00Z',
                    duration: 30,
                    priority: 'high'
                },
                {
                    id: 'update_3',
                    title: '格局庫管理系統',
                    type: 'feature',
                    version: '5.2',
                    status: 'completed',
                    description: '新增格局庫瀏覽與管理功能',
                    changes: [
                        { type: 'added', content: '格局庫瀏覽界面' },
                        { type: 'added', content: '格局搜索與過濾功能' },
                        { type: 'added', content: '格局添加與編輯功能' }
                    ],
                    created_at: '2026-02-08T09:00:00Z',
                    executed_at: '2026-02-08T09:40:00Z',
                    duration: 40,
                    priority: 'medium'
                },
                {
                    id: 'update_4',
                    title: '系統狀態監控',
                    type: 'feature',
                    version: '5.2',
                    status: 'completed',
                    description: '新增系統健康狀態監控面板',
                    changes: [
                        { type: 'added', content: '數據庫連接狀態監控' },
                        { type: 'added', content: 'AI引擎健康檢查' },
                        { type: 'added', content: '系統性能指標顯示' }
                    ],
                    created_at: '2026-02-07T16:20:00Z',
                    executed_at: '2026-02-07T17:00:00Z',
                    duration: 40,
                    priority: 'medium'
                },
                {
                    id: 'update_5',
                    title: 'Supabase連接優化',
                    type: 'optimization',
                    version: '5.2',
                    status: 'pending',
                    description: '優化Supabase連接穩定性與錯誤處理',
                    changes: [
                        { type: 'optimization', content: '改進連接超時處理機制' },
                        { type: 'optimization', content: '添加自動重連功能' },
                        { type: 'optimization', content: '優化數據同步效率' }
                    ],
                    created_at: '2026-02-11T10:00:00Z',
                    executed_at: null,
                    duration: 45,
                    priority: 'medium'
                }
            ];
            
            // 保存到本地存儲
            localStorage.setItem('system_updates', JSON.stringify(allUpdates));
            
            updateStatistics();
            applyFilters();
            
            showNotification('info', '使用示例更新指令數據');
        }
        
        // 更新統計
        function updateStatistics() {
            const total = allUpdates.length;
            const completed = allUpdates.filter(u => u.status === 'completed').length;
            const pending = allUpdates.filter(u => u.status === 'pending').length;
            const failed = allUpdates.filter(u => u.status === 'failed').length;
            
            // 計算Bug修復數量
            const bugFixes = allUpdates.filter(u => u.type === 'bug').length;
            
            // 計算新功能數量
            const features = allUpdates.filter(u => u.type === 'feature').length;
            
            // 計算優化數量
            const optimizations = allUpdates.filter(u => u.type === 'optimization').length;
            
            // 計算成功率
            const successRate = completed > 0 ? Math.round((completed / (completed + failed)) * 100) : 0;
            
            // 計算平均耗時
            const completedUpdates = allUpdates.filter(u => u.status === 'completed');
            const totalDuration = completedUpdates.reduce((sum, update) => sum + (update.duration || 0), 0);
            const avgDuration = completedUpdates.length > 0 ? Math.round(totalDuration / completedUpdates.length) : 0;
            
            // 更新顯示
            document.getElementById('total-updates').textContent = total;
            document.getElementById('bug-fixes').textContent = bugFixes;
            document.getElementById('features-added').textContent = features;
            document.getElementById('optimizations').textContent = optimizations;
            document.getElementById('success-rate').textContent = successRate + '%';
            document.getElementById('avg-duration').textContent = avgDuration + 'min';
            
            document.getElementById('pending-updates').textContent = pending;
            document.getElementById('completed-updates').textContent = completed;
        }
        
        // 應用篩選
        function applyFilters() {
            const statusFilter = document.getElementById('status-filter').value;
            const typeFilter = document.getElementById('type-filter').value;
            const versionFilter = document.getElementById('version-filter').value;
            const searchTerm = document.getElementById('search-updates').value.toLowerCase();
            
            filteredUpdates = allUpdates.filter(update => {
                // 狀態篩選
                if (statusFilter && update.status !== statusFilter) {
                    return false;
                }
                
                // 類型篩選
                if (typeFilter && update.type !== typeFilter) {
                    return false;
                }
                
                // 版本篩選
                if (versionFilter && !update.version.includes(versionFilter)) {
                    return false;
                }
                
                // 搜尋篩選
                if (searchTerm) {
                    const searchText = (update.title + ' ' + update.description + ' ' + 
                                       update.changes.map(c => c.content).join(' ')).toLowerCase();
                    if (!searchText.includes(searchTerm)) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // 按創建時間排序（最新的在前）
            filteredUpdates.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            // 顯示更新
            displayUpdatesPage(1);
        }
        
        // 顯示更新頁面
        function displayUpdatesPage(page) {
            currentPage = page;
            const startIndex = (page - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageUpdates = filteredUpdates.slice(startIndex, endIndex);
            
            const updatesList = document.getElementById('updates-list');
            const paginationControls = document.getElementById('pagination-controls');
            
            if (pageUpdates.length === 0) {
                updatesList.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-search"></i>
                        <p>找不到符合條件的更新指令</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">
                            嘗試調整篩選條件或添加新更新
                        </p>
                    </div>
                `;
                paginationControls.style.display = 'none';
                return;
            }
            
            let updatesHTML = '';
            
            pageUpdates.forEach(update => {
                const statusClass = update.status === 'completed' ? 'completed' : 
                                  update.status === 'pending' ? 'pending' : 'failed';
                const statusText = update.status === 'completed' ? '已完成' : 
                                  update.status === 'pending' ? '待執行' : '執行失敗';
                
                const typeText = update.type === 'bug' ? 'Bug修復' :
                                update.type === 'feature' ? '新功能' :
                                update.type === 'optimization' ? '性能優化' :
                                update.type === 'security' ? '安全更新' : '文檔更新';
                
                const priorityText = update.priority === 'low' ? '低' :
                                   update.priority === 'medium' ? '中' :
                                   update.priority === 'high' ? '高' : '緊急';
                
                updatesHTML += `
                    <div class="update-item ${statusClass}" onclick="viewUpdateDetail('${update.id}')">
                        <div class="update-header-row">
                            <div class="update-title-section">
                                <h4 style="margin: 0; color: #2c3e50;">${update.title}</h4>
                                <div class="update-meta">
                                    <div class="update-meta-item">
                                        <i class="fas fa-tag"></i>
                                        <span>${typeText}</span>
                                    </div>
                                    <div class="update-meta-item">
                                        <i class="fas fa-code-branch"></i>
                                        <span>V${update.version}</span>
                                    </div>
                                    <div class="update-meta-item">
                                        <i class="fas fa-clock"></i>
                                        <span>${update.duration || 30}分鐘</span>
                                    </div>
                                    <div class="update-meta-item">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <span>優先級：${priorityText}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="update-status ${statusClass}">${statusText}</div>
                        </div>
                        
                        <div class="update-content">
                            <div class="update-description">
                                ${update.description}
                            </div>
                            
                            <div class="update-changes">
                                ${update.changes.slice(0, 3).map(change => `
                                    <div class="change-item change-${change.type}">
                                        <div class="change-icon">
                                            <i class="fas fa-${change.type === 'added' ? 'plus-circle' : 
                                                              change.type === 'fixed' ? 'wrench' : 
                                                              change.type === 'removed' ? 'minus-circle' : 'sync-alt'}"></i>
                                        </div>
                                        <div class="change-content">${change.content}</div>
                                    </div>
                                `).join('')}
                                
                                ${update.changes.length > 3 ? `
                                    <div style="text-align: center; padding: 10px; color: #7f8c8d; font-size: 0.9em;">
                                        <i class="fas fa-ellipsis-h"></i>
                                        還有 ${update.changes.length - 3} 個變更
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="update-actions">
                            ${update.status === 'pending' ? `
                                <button class="action-button primary" onclick="event.stopPropagation(); executeUpdate('${update.id}')">
                                    <i class="fas fa-play"></i> 執行更新
                                </button>
                            ` : ''}
                            
                            <button class="action-button secondary" onclick="event.stopPropagation(); editUpdate('${update.id}')">
                                <i class="fas fa-edit"></i> 編輯
                            </button>
                            
                            <button class="action-button secondary" onclick="event.stopPropagation(); duplicateUpdate('${update.id}')">
                                <i class="fas fa-copy"></i> 複製
                            </button>
                            
                            ${update.status === 'completed' ? `
                                <button class="action-button secondary" onclick="event.stopPropagation(); revertUpdate('${update.id}')">
                                    <i class="fas fa-undo"></i> 回滾
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            updatesList.innerHTML = updatesHTML;
            
            // 更新分頁控制
            const totalPages = Math.ceil(filteredUpdates.length / itemsPerPage);
            if (totalPages > 1) {
                paginationControls.style.display = 'flex';
                document.getElementById('page-info').textContent = 
                    `第 ${page} 頁，共 ${totalPages} 頁`;
            } else {
                paginationControls.style.display = 'none';
            }
        }
        
        // 上一頁
        function previousPage() {
            if (currentPage > 1) {
                displayUpdatesPage(currentPage - 1);
            }
        }
        
        // 下一頁
        function nextPage() {
            const totalPages = Math.ceil(filteredUpdates.length / itemsPerPage);
            if (currentPage < totalPages) {
                displayUpdatesPage(currentPage + 1);
            }
        }
        
        // 重置篩選
        function resetFilters() {
            document.getElementById('status-filter').value = '';
            document.getElementById('type-filter').value = '';
            document.getElementById('version-filter').value = '';
            document.getElementById('search-updates').value = '';
            
            filteredUpdates = [...allUpdates];
            displayUpdatesPage(1);
            
            showNotification('info', '篩選條件已重置');
        }
        
        // 查看更新詳情
        function viewUpdateDetail(updateId) {
            const update = allUpdates.find(u => u.id === updateId);
            if (!update) return;
            
            currentUpdate = update;
            
            const statusClass = update.status === 'completed' ? 'completed' : 
                              update.status === 'pending' ? 'pending' : 'failed';
            const statusText = update.status === 'completed' ? '已完成' : 
                              update.status === 'pending' ? '待執行' : '執行失敗';
            
            const typeText = update.type === 'bug' ? 'Bug修復' :
                            update.type === 'feature' ? '新功能' :
                            update.type === 'optimization' ? '性能優化' :
                            update.type === 'security' ? '安全更新' : '文檔更新';
            
            const priorityText = update.priority === 'low' ? '低' :
                               update.priority === 'medium' ? '中' :
                               update.priority === 'high' ? '高' : '緊急';
            
            let detailHTML = `
                <div style="padding: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2 style="color: #2c3e50; margin: 0;">${update.title}</h2>
                        <span class="update-status ${statusClass}" style="font-size: 1.1em;">
                            ${statusText}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">基本資訊</h4>
                            <div style="color: #7f8c8d;">
                                <div style="margin-bottom: 8px;">
                                    <strong>類型：</strong>
                                    <span>${typeText}</span>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>版本：</strong>
                                    <span>V${update.version}</span>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>優先級：</strong>
                                    <span>${priorityText}</span>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>預計耗時：</strong>
                                    <span>${update.duration || 30}分鐘</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">時間資訊</h4>
                            <div style="color: #7f8c8d;">
                                <div style="margin-bottom: 8px;">
                                    <strong>創建時間：</strong>
                                    <span>${new Date(update.created_at).toLocaleString('zh-TW')}</span>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>${update.status === 'completed' ? '執行時間：' : '預計執行：'}</strong>
                                    <span>${update.executed_at ? new Date(update.executed_at).toLocaleString('zh-TW') : '待安排'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <h4 style="color: #2c3e50; margin-bottom: 10px;">更新描述</h4>
                        <p style="color: #2c3e50; line-height: 1.6;">${update.description}</p>
                    </div>
                    
                    <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e0e0e0;">
                        <h4 style="color: #2c3e50; margin-bottom: 15px;">變更內容</h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${update.changes.map(change => `
                                <div class="change-item change-${change.type}" style="margin-bottom: 10px;">
                                    <div class="change-icon">
                                        <i class="fas fa-${change.type === 'added' ? 'plus-circle' : 
                                                          change.type === 'fixed' ? 'wrench' : 
                                                          change.type === 'removed' ? 'minus-circle' : 'sync-alt'}"></i>
                                    </div>
                                    <div class="change-content">${change.content}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            // 創建模態框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-info-circle"></i> 更新詳情</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${detailHTML}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="this.parentElement.parentElement.parentElement.remove()">
                            關閉
                        </button>
                        <button type="button" class="btn btn-primary" onclick="editUpdate('${update.id}'); this.parentElement.parentElement.parentElement.remove()">
                            <i class="fas fa-edit"></i> 編輯
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 點擊外部關閉
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // 新增更新
        function addNewUpdate() {
            currentUpdate = null;
            document.getElementById('add-update-modal').style.display = 'flex';
        }
        
        // 關閉新增更新模態框
        function closeAddUpdateModal() {
            document.getElementById('add-update-modal').style.display = 'none';
            currentUpdate = null;
        }
        
        // 保存更新
        function saveUpdate() {
            const form = document.getElementById('update-form');
            if (!form.checkValidity()) {
                showNotification('error', '請填寫所有必填欄位');
                return;
            }
            
            try {
                const title = document.getElementById('update-title').value.trim();
                const type = document.getElementById('update-type').value;
                const version = document.getElementById('update-version').value;
                const description = document.getElementById('update-description').value.trim();
                const changesText = document.getElementById('update-changes').value.trim();
                const priority = document.getElementById('update-priority').value;
                const duration = parseInt(document.getElementById('update-duration').value) || 30;
                const files = document.getElementById('update-files').value.split(',').map(f => f.trim()).filter(f => f);
                const tests = document.getElementById('update-tests').value.trim();
                
                // 解析變更內容
                const changes = [];
                const changeLines = changesText.split('\n');
                changeLines.forEach(line => {
                    const trimmedLine = line.trim();
                    if (trimmedLine) {
                        if (trimmedLine.startsWith('[新增]')) {
                            changes.push({
                                type: 'added',
                                content: trimmedLine.substring(4).trim()
                            });
                        } else if (trimmedLine.startsWith('[修復]')) {
                            changes.push({
                                type: 'fixed',
                                content: trimmedLine.substring(4).trim()
                            });
                        } else if (trimmedLine.startsWith('[優化]')) {
                            changes.push({
                                type: 'changed',
                                content: trimmedLine.substring(4).trim()
                            });
                        } else if (trimmedLine.startsWith('[移除]')) {
                            changes.push({
                                type: 'removed',
                                content: trimmedLine.substring(4).trim()
                            });
                        } else {
                            changes.push({
                                type: 'changed',
                                content: trimmedLine
                            });
                        }
                    }
                });
                
                const newUpdate = {
                    id: currentUpdate ? currentUpdate.id : 'update_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                    title: title,
                    type: type,
                    version: version,
                    status: currentUpdate ? currentUpdate.status : 'pending',
                    description: description || '暫無描述',
                    changes: changes,
                    created_at: currentUpdate ? currentUpdate.created_at : new Date().toISOString(),
                    executed_at: currentUpdate ? currentUpdate.executed_at : null,
                    duration: duration,
                    priority: priority,
                    related_files: files,
                    test_instructions: tests
                };
                
                if (currentUpdate) {
                    // 更新現有更新
                    const index = allUpdates.findIndex(u => u.id === currentUpdate.id);
                    if (index !== -1) {
                        allUpdates[index] = newUpdate;
                    }
                } else {
                    // 添加新更新
                    allUpdates.unshift(newUpdate);
                }
                
                // 保存到本地存儲
                localStorage.setItem('system_updates', JSON.stringify(allUpdates));
                
                // 更新顯示
                updateStatistics();
                applyFilters();
                
                // 關閉模態框
                closeAddUpdateModal();
                
                showNotification('success', currentUpdate ? '更新指令修改成功' : '新更新指令添加成功');
                
            } catch (error) {
                console.error('保存更新失敗:', error);
                showNotification('error', '保存更新失敗：' + error.message);
            }
        }
        
        // 編輯更新
        function editUpdate(updateId) {
            const update = allUpdates.find(u => u.id === updateId);
            if (!update) return;
            
            currentUpdate = update;
            
            // 填充表單
            document.getElementById('update-title').value = update.title;
            document.getElementById('update-type').value = update.type;
            document.getElementById('update-version').value = update.version;
            document.getElementById('update-description').value = update.description || '';
            document.getElementById('update-priority').value = update.priority || 'medium';
            document.getElementById('update-duration').value = update.duration || 30;
            
            // 格式化變更內容
            const changesText = update.changes.map(change => {
                const prefix = change.type === 'added' ? '[新增]' :
                              change.type === 'fixed' ? '[修復]' :
                              change.type === 'changed' ? '[優化]' : '[移除]';
                return `${prefix} ${change.content}`;
            }).join('\n');
            document.getElementById('update-changes').value = changesText;
            
            // 填充其他字段
            document.getElementById('update-files').value = update.related_files ? update.related_files.join(', ') : '';
            document.getElementById('update-tests').value = update.test_instructions || '';
            
            // 打開模態框
            document.getElementById('add-update-modal').style.display = 'flex';
        }
        
        // 複製更新
        function duplicateUpdate(updateId) {
            const update = allUpdates.find(u => u.id === updateId);
            if (!update) return;
            
            // 創建複製
            const duplicate = {
                ...update,
                id: 'update_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
                title: update.title + ' (副本)',
                status: 'pending',
                created_at: new Date().toISOString(),
                executed_at: null
            };
            
            allUpdates.unshift(duplicate);
            
            // 保存到本地存儲
            localStorage.setItem('system_updates', JSON.stringify(allUpdates));
            
            // 更新顯示
            updateStatistics();
            applyFilters();
            
            showNotification('success', '更新指令複製成功');
        }
        
        // 執行更新
        function executeUpdate(updateId) {
            const update = allUpdates.find(u => u.id === updateId);
            if (!update) return;
            
            currentUpdate = update;
            
            // 打開執行模態框
            document.getElementById('execute-update-modal').style.display = 'flex';
            
            // 準備執行內容
            const executeContent = document.getElementById('execute-update-content');
            executeContent.innerHTML = `
                <h4 style="color: #2c3e50; margin-bottom: 15px;">${update.title}</h4>
                <div style="color: #7f8c8d; margin-bottom: 15px;">
                    <p><strong>類型：</strong> ${update.type === 'bug' ? 'Bug修復' :
                                               update.type === 'feature' ? '新功能' :
                                               update.type === 'optimization' ? '性能優化' :
                                               update.type === 'security' ? '安全更新' : '文檔更新'}</p>
                    <p><strong>預計耗時：</strong> ${update.duration || 30}分鐘</p>
                    <p><strong>變更數量：</strong> ${update.changes.length}個</p>
                </div>
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px;">
                    <p><strong>描述：</strong> ${update.description}</p>
                </div>
            `;
            
            // 清空日誌
            document.getElementById('update-log').innerHTML = '';
            
            // 重置進度條
            document.getElementById('update-progress').style.width = '0%';
            document.getElementById('progress-text').textContent = '準備中...';
            
            // 啟用開始按鈕
            document.getElementById('start-update-btn').disabled = false;
            document.getElementById('cancel-update-btn').disabled = false;
        }
        
        // 開始執行更新
        function startUpdate() {
            if (!currentUpdate) return;
            
            // 禁用按鈕
            document.getElementById('start-update-btn').disabled = true;
            document.getElementById('cancel-update-btn').disabled = false;
            
            // 開始執行
            simulateUpdateExecution();
        }
        
        // 模擬更新執行
        function simulateUpdateExecution() {
            let progress = 0;
            const logContainer = document.getElementById('update-log');
            const progressBar = document.getElementById('update-progress');
            const progressText = document.getElementById('progress-text');
            
            // 清空日誌
            logContainer.innerHTML = '';
            
            // 添加初始日誌
            addLog('開始執行更新...', 'info');
            
            // 模擬執行過程
            updateInterval = setInterval(() => {
                progress += Math.random() * 5 + 5; // 每次增加5-10%
                
                if (progress >= 100) {
                    progress = 100;
                    clearInterval(updateInterval);
                    
                    // 更新狀態為完成
                    const index = allUpdates.findIndex(u => u.id === currentUpdate.id);
                    if (index !== -1) {
                        allUpdates[index].status = 'completed';
                        allUpdates[index].executed_at = new Date().toISOString();
                        
                        // 保存到本地存儲
                        localStorage.setItem('system_updates', JSON.stringify(allUpdates));
                        
                        // 更新統計
                        updateStatistics();
                        
                        // 重新應用篩選
                        applyFilters();
                    }
                    
                    addLog('更新執行完成！', 'success');
                    progressText.textContent = '完成！';
                    
                    // 顯示完成訊息
                    setTimeout(() => {
                        showNotification('success', '更新執行完成');
                        closeExecuteUpdateModal();
                    }, 1500);
                }
                
                progressBar.style.width = progress + '%';
                progressText.textContent = '執行中... ' + Math.round(progress) + '%';
                
                // 隨機添加日誌
                if (progress < 30) {
                    addLog('正在初始化更新環境...', 'info');
                } else if (progress < 60) {
                    addLog('正在應用變更...', 'info');
                } else if (progress < 90) {
                    addLog('正在驗證更新結果...', 'info');
                }
                
            }, 500); // 每0.5秒更新一次
        }
        
        // 添加日誌
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('update-log');
            const timestamp = new Date().toLocaleTimeString('zh-TW', { hour12: false });
            
            const logEntry = document.createElement('div');
            logEntry.style.padding = '5px 0';
            logEntry.style.borderBottom = '1px solid rgba(255, 255, 255, 0.1)';
            logEntry.style.color = type === 'error' ? '#e74c3c' : 
                                 type === 'success' ? '#2ecc71' : 
                                 type === 'warning' ? '#f39c12' : '#ecf0f1';
            
            logEntry.innerHTML = `<span style="color: #95a5a6;">[${timestamp}]</span> ${message}`;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 取消更新
        function cancelUpdate() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            
            // 更新狀態為失敗
            const index = allUpdates.findIndex(u => u.id === currentUpdate.id);
            if (index !== -1) {
                allUpdates[index].status = 'failed';
                
                // 保存到本地存儲
                localStorage.setItem('system_updates', JSON.stringify(allUpdates));
                
                // 更新統計
                updateStatistics();
                
                // 重新應用篩選
                applyFilters();
            }
            
            addLog('更新已取消', 'warning');
            showNotification('warning', '更新已取消');
            
            setTimeout(() => {
                closeExecuteUpdateModal();
            }, 1000);
        }
        
        // 關閉執行更新模態框
        function closeExecuteUpdateModal() {
            if (updateInterval) {
                clearInterval(updateInterval);
                updateInterval = null;
            }
            
            document.getElementById('execute-update-modal').style.display = 'none';
            currentUpdate = null;
        }
        
        // 檢查更新
        function checkForUpdates() {
            showNotification('info', '正在檢查更新...');
            
            // 模擬檢查過程
            setTimeout(() => {
                const pendingCount = allUpdates.filter(u => u.status === 'pending').length;
                
                if (pendingCount > 0) {
                    showNotification('info', `發現 ${pendingCount} 個待執行更新`);
                } else {
                    showNotification('success', '系統已是最新版本');
                }
            }, 1000);
        }
        
        // 執行待處理更新
        function runPendingUpdates() {
            const pendingUpdates = allUpdates.filter(u => u.status === 'pending');
            
            if (pendingUpdates.length === 0) {
                showNotification('info', '沒有待執行的更新');
                return;
            }
            
            if (confirm(`確定要執行所有 ${pendingUpdates.length} 個待處理更新嗎？`)) {
                showNotification('info', `開始執行 ${pendingUpdates.length} 個更新...`);
                
                // 執行第一個更新
                if (pendingUpdates.length > 0) {
                    executeUpdate(pendingUpdates[0].id);
                }
            }
        }
        
        // 導出更新歷史
        function exportUpdateHistory() {
            try {
                const exportData = {
                    version: 'V5.2',
                    export_time: new Date().toISOString(),
                    total_updates: allUpdates.length,
                    updates: allUpdates
                };
                
                const jsonStr = JSON.stringify(exportData, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `update-history-${new Date().toISOString().slice(0, 10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification('success', `已導出 ${allUpdates.length} 個更新記錄`);
                
            } catch (error) {
                console.error('導出更新歷史失敗:', error);
                showNotification('error', '導出更新歷史失敗');
            }
        }
        
        // 查看更新計劃
        function viewUpdateSchedule() {
            const pendingUpdates = allUpdates.filter(u => u.status === 'pending');
            
            if (pendingUpdates.length === 0) {
                showNotification('info', '暫無更新計劃');
                return;
            }
            
            let scheduleHTML = `
                <div style="padding: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">更新計劃</h3>
                    <p style="color: #7f8c8d; margin-bottom: 20px;">共 ${pendingUpdates.length} 個待執行更新</p>
            `;
            
            pendingUpdates.forEach((update, index) => {
                const priorityText = update.priority === 'low' ? '低' :
                                   update.priority === 'medium' ? '中' :
                                   update.priority === 'high' ? '高' : '緊急';
                
                scheduleHTML += `
                    <div style="background: ${index % 2 === 0 ? '#f8f9fa' : 'white'}; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <h4 style="margin: 0; color: #2c3e50;">${update.title}</h4>
                                <p style="margin: 5px 0 0 0; color: #7f8c8d; font-size: 0.9em;">
                                    優先級：${priorityText} | 預計耗時：${update.duration || 30}分鐘
                                </p>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="executeUpdate('${update.id}'); this.parentElement.parentElement.parentElement.parentElement.remove()">
                                執行
                            </button>
                        </div>
                    </div>
                `;
            });
            
            scheduleHTML += '</div>';
            
            // 創建模態框
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="modal-header">
                        <h3><i class="fas fa-calendar-alt"></i> 更新計劃</h3>
                        <button class="modal-close" onclick="this.parentElement.parentElement.remove()">&times;</button>
                    </div>
                    <div class="modal-body">
                        ${scheduleHTML}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline" onclick="this.parentElement.parentElement.remove()">
                            關閉
                        </button>
                        <button type="button" class="btn btn-primary" onclick="runPendingUpdates(); this.parentElement.parentElement.remove()">
                            執行所有更新
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 點擊外部關閉
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        // 回滾更新
        function revertUpdate(updateId) {
            const update = allUpdates.find(u => u.id === updateId);
            if (!update) return;
            
            if (confirm(`確定要回滾更新「${update.title}」嗎？這可能會影響系統穩定性。`)) {
                showNotification('info', '開始回滾更新...');
                
                // 模擬回滾過程
                setTimeout(() => {
                    // 更新狀態為待執行（相當於需要重新執行）
                    const index = allUpdates.findIndex(u => u.id === updateId);
                    if (index !== -1) {
                        allUpdates[index].status = 'pending';
                        allUpdates[index].executed_at = null;
                        
                        // 保存到本地存儲
                        localStorage.setItem('system_updates', JSON.stringify(allUpdates));
                        
                        // 更新統計
                        updateStatistics();
                        
                        // 重新應用篩選
                        applyFilters();
                    }
                    
                    showNotification('success', '更新已標記為待執行，需要重新執行以應用回滾');
                }, 1500);
            }
        }
        
        // 顯示錯誤
        function showError(message) {
            const updatesList = document.getElementById('updates-list');
            updatesList.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <p>載入失敗</p>
                    <p style="font-size: 0.9em; color: #e74c3c;">${message}</p>
                </div>
            `;
        }
        
        // 顯示通知
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                   type === 'error' ? 'exclamation-circle' : 
                                   type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // 自動移除
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 載入更新指令
            loadUpdates();
            
            // 移動端選單切換
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const navMenu = document.querySelector('.nav-menu');
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    navMenu.classList.toggle('active');
                });
            }
            
            // 點擊頁面其他地方關閉選單
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.nav-menu') && !e.target.closest('.mobile-menu-btn')) {
                    navMenu.classList.remove('active');
                }
            });
            
            // 監聽搜索輸入
            document.getElementById('search-updates').addEventListener('input', applyFilters);
            
            // 監聽篩選器變化
            document.getElementById('status-filter').addEventListener('change', applyFilters);
            document.getElementById('type-filter').addEventListener('change', applyFilters);
            document.getElementById('version-filter').addEventListener('change', applyFilters);
            
            // 點擊模態框外部關閉
            document.getElementById('add-update-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('add-update-modal')) {
                    closeAddUpdateModal();
                }
            });
            
            document.getElementById('execute-update-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('execute-update-modal')) {
                    closeExecuteUpdateModal();
                }
            });
        });
    </script>
</body>
</html>