<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>賽後技術分析 - 己土玄學AI足球分析系統</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 賽後分析頁面專用樣式 */
        .match-selection-section, .result-input-section, .verification-section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow-md);
        }

        .section-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .section-header i {
            font-size: 24px;
            color: var(--secondary-color);
        }

        .section-header h2 {
            font-size: 22px;
            color: var(--primary-color);
            margin: 0;
        }

        .match-selector {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 25px;
            border: 2px dashed var(--border-color);
        }

        .match-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .match-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            border-left: 5px solid var(--secondary-color);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: var(--shadow-sm);
        }

        .match-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .match-card.selected {
            border-left-color: var(--success-color);
            background: linear-gradient(to right, rgba(39, 174, 96, 0.05), white);
        }

        .match-card.pending {
            border-left-color: var(--warning-color);
        }

        .match-card.completed {
            border-left-color: var(--gray-color);
            opacity: 0.8;
        }

        .match-id {
            font-weight: 700;
            color: var(--primary-color);
            font-size: 18px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .match-teams {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .match-time {
            font-size: 13px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .match-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .status-completed {
            background: rgba(149, 165, 166, 0.1);
            color: var(--gray-color);
        }

        /* 結果輸入表單 */
        .result-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 15px;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 15px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            background: white;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .score-input {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .score-input input {
            text-align: center;
            font-size: 18px;
            font-weight: 700;
        }

        .vs-text {
            font-weight: 700;
            color: var(--text-light);
        }

        .btn-submit {
            background: linear-gradient(135deg, var(--success-color) 0%, #229954 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--border-radius);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin-top: 20px;
        }

        .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(39, 174, 96, 0.3);
        }

        /* 驗證結果區域 */
        .verification-results {
            display: none;
            margin-top: 30px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .accuracy-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .metric-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            box-shadow: var(--shadow-sm);
            border-top: 4px solid transparent;
        }

        .metric-card.direction {
            border-top-color: var(--primary-color);
        }

        .metric-card.score {
            border-top-color: var(--secondary-color);
        }

        .metric-card.corners {
            border-top-color: var(--warning-color);
        }

        .metric-card.cards {
            border-top-color: var(--danger-color);
        }

        .metric-card.possession {
            border-top-color: var(--info-color);
        }

        .metric-label {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .metric-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .metric-value.correct {
            color: var(--success-color);
        }

        .metric-value.incorrect {
            color: var(--danger-color);
        }

        .metric-value.partial {
            color: var(--warning-color);
        }

        .metric-status {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
            display: inline-block;
        }

        .status-correct {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
        }

        .status-incorrect {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .status-partial {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        /* 比較表格 */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .comparison-table th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        .comparison-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .comparison-table tr:hover {
            background: #f8f9fa;
        }

        .prediction-col {
            background: rgba(52, 152, 219, 0.05);
        }

        .actual-col {
            background: rgba(39, 174, 96, 0.05);
        }

        /* 懶人指令包 */
        .lazy-package {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: var(--border-radius);
            padding: 25px;
            border: 2px solid var(--border-color);
            margin-bottom: 30px;
        }

        .lazy-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }

        .lazy-header h3 {
            color: var(--primary-color);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .package-id {
            background: var(--accent-color);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .code-block {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            overflow-x: auto;
            margin-bottom: 20px;
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
        }

        .instruction-list {
            margin-bottom: 20px;
        }

        .instruction-item {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid transparent;
        }

        .instruction-item.critical {
            border-left-color: var(--danger-color);
            background: rgba(231, 76, 60, 0.05);
        }

        .instruction-item.important {
            border-left-color: var(--warning-color);
            background: rgba(243, 156, 18, 0.05);
        }

        .instruction-item.suggestion {
            border-left-color: var(--info-color);
            background: rgba(52, 152, 219, 0.05);
        }

        .instruction-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .instruction-icon.critical {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
        }

        .instruction-icon.important {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
        }

        .instruction-icon.suggestion {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary-color);
        }

        .instruction-content {
            flex: 1;
        }

        .instruction-content h4 {
            margin: 0 0 5px 0;
            font-size: 16px;
            color: var(--primary-color);
        }

        .instruction-content p {
            margin: 0;
            font-size: 14px;
            color: var(--text-secondary);
        }

        /* 操作按鈕 */
        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .action-buttons .btn {
            flex: 1;
            min-width: 150px;
        }

        /* 技術分析詳情 */
        .technique-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .technique-item {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }

        .technique-label {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .technique-values {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .technique-value {
            font-size: 24px;
            font-weight: 700;
        }

        .technice-home {
            color: var(--secondary-color);
        }

        .technice-away {
            color: var(--accent-color);
        }

        .technique-diff {
            font-size: 14px;
            color: var(--text-light);
        }

        /* 響應式調整 */
        @media (max-width: 768px) {
            .match-selection-section, .result-input-section, .verification-section {
                padding: 20px;
            }
            
            .match-grid {
                grid-template-columns: 1fr;
            }
            
            .result-form {
                grid-template-columns: 1fr;
            }
            
            .score-input {
                flex-direction: column;
                gap: 15px;
            }
            
            .accuracy-metrics {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .comparison-table {
                font-size: 14px;
            }
            
            .comparison-table th,
            .comparison-table td {
                padding: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .instruction-item {
                flex-direction: column;
                gap: 10px;
            }
        }

        @media (max-width: 480px) {
            .accuracy-metrics {
                grid-template-columns: 1fr;
            }
            
            .technique-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 返回導航 -->
        <div class="back-nav">
            <a href="index.html" class="back-link">
                <i class="fas fa-arrow-left"></i>
                返回主儀表板
            </a>
            <span class="nav-title">賽後技術分析系統</span>
        </div>

        <!-- 系統標題 -->
        <header class="page-header">
            <h1><i class="fas fa-chart-line"></i> 賽後技術分析與驗證</h1>
            <p class="subtitle">輸入實際賽果，生成驗證報告與參數優化指令包</p>
        </header>

        <!-- 比賽選擇區域 -->
        <div class="match-selection-section">
            <div class="section-header">
                <i class="fas fa-list"></i>
                <h2>選擇待驗證比賽</h2>
            </div>
            
            <div class="match-selector">
                <p class="selector-info">
                    <i class="fas fa-info-circle"></i>
                    請選擇已完成預測但尚未驗證的比賽進行賽後分析
                </p>
                
                <div class="match-grid" id="matchGrid">
                    <!-- 動態載入比賽 -->
                </div>
                
                <div class="no-matches" id="noMatches" style="display: none;">
                    <div class="empty-state">
                        <i class="fas fa-clipboard-check fa-3x"></i>
                        <h3>暫無待驗證比賽</h3>
                        <p>所有比賽已完成驗證，或暫無賽前預測數據</p>
                        <a href="pre-match.html" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i>
                            前往賽前預測
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- 結果輸入區域 -->
        <div class="result-input-section">
            <div class="section-header">
                <i class="fas fa-edit"></i>
                <h2>輸入實際比賽結果</h2>
            </div>
            
            <div id="selectedMatchInfo" style="display: none;">
                <div class="selected-match">
                    <h3 id="selectedMatchId">FB3200</h3>
                    <p id="selectedMatchTeams">馬德里CFF女足 vs 特內里費女足</p>
                    <p id="selectedMatchTime">2026-02-05 02:00:00</p>
                </div>
            </div>
            
            <div class="result-form">
                <!-- 半場比分 -->
                <div class="form-group">
                    <label>半場比分</label>
                    <div class="score-input">
                        <input type="number" id="halfHomeScore" class="form-control" min="0" max="20" value="0">
                        <span class="vs-text">:</span>
                        <input type="number" id="halfAwayScore" class="form-control" min="0" max="20" value="0">
                    </div>
                </div>
                
                <!-- 全場比分 -->
                <div class="form-group">
                    <label>全場比分</label>
                    <div class="score-input">
                        <input type="number" id="fullHomeScore" class="form-control" min="0" max="20" value="0">
                        <span class="vs-text">:</span>
                        <input type="number" id="fullAwayScore" class="form-control" min="0" max="20" value="0">
                    </div>
                </div>
                
                <!-- 角球數據 -->
                <div class="form-group">
                    <label>角球數據</label>
                    <input type="text" id="cornerData" class="form-control" placeholder="格式: 總數 (主隊:客隊)">
                </div>
                
                <!-- 技術分析 -->
                <div class="form-group">
                    <label>技術分析數據</label>
                    <textarea id="techniqueData" class="form-control" rows="4" placeholder="請按照格式輸入技術數據:
進攻:124-73
黃牌:0-1
射正:4-2
..."></textarea>
                    <small class="form-help">每行一個數據，格式: 指標:主隊-客隊</small>
                </div>
            </div>
            
            <button id="submitResults" class="btn-submit" disabled>
                <i class="fas fa-check-circle"></i>
                提交賽果並生成驗證報告
            </button>
        </div>

        <!-- 驗證結果區域 -->
        <div id="verificationResults" class="verification-section" style="display: none;">
            <div class="section-header">
                <i class="fas fa-file-contract"></i>
                <h2>驗證報告與AI優化指令</h2>
            </div>
            
            <!-- 準確度指標 -->
            <div class="accuracy-metrics" id="accuracyMetrics">
                <!-- 動態生成 -->
            </div>
            
            <!-- 預測與實際比較 -->
            <h3><i class="fas fa-balance-scale"></i> 預測 vs 實際</h3>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>指標</th>
                        <th>預測結果</th>
                        <th>實際結果</th>
                        <th>準確度</th>
                    </tr>
                </thead>
                <tbody id="comparisonBody">
                    <!-- 動態生成 -->
                </tbody>
            </table>
            
            <!-- 技術分析詳情 -->
            <h3><i class="fas fa-chart-bar"></i> 技術分析詳情</h3>
            <div class="technique-details" id="techniqueDetails">
                <!-- 動態生成 -->
            </div>
            
            <!-- 懶人指令包 -->
            <div class="lazy-package">
                <div class="lazy-header">
                    <h3><i class="fas fa-code"></i> AI參數優化指令包</h3>
                    <div class="package-id">LPK-<span id="packageId">001</span></div>
                </div>
                
                <div class="instruction-list" id="instructionList">
                    <!-- 動態生成 -->
                </div>
                
                <div class="code-block">
                    <pre id="lazyCode">// 懶人指令包 - AI參數優化代碼
// 生成時間: <span id="generateTime"></span>
// 比賽ID: <span id="lazyMatchId"></span>

// 請複製以下代碼到 ai_parameters.csv 或相應JS文件中執行</pre>
                </div>
            </div>
            
            <!-- 操作按鈕 -->
            <div class="action-buttons">
                <button id="saveVerification" class="btn btn-primary">
                    <i class="fas fa-save"></i> 保存驗證報告
                </button>
                <button id="copyCode" class="btn btn-secondary">
                    <i class="fas fa-copy"></i> 複製優化指令
                </button>
                <button id="applyUpdates" class="btn btn-success">
                    <i class="fas fa-play"></i> 自動執行優化
                </button>
                <button id="newVerification" class="btn btn-accent">
                    <i class="fas fa-redo"></i> 新驗證
                </button>
                <button id="downloadUpdatePackage" class="btn btn-warning" style="display: none;">
                    <i class="fas fa-download"></i> 下載更新包給DeepSeek
                </button>
            </div>
        </div>

        <!-- 加載動畫 -->
        <div id="loadingOverlay" class="loading-overlay" style="display: none;">
            <div class="loading-spinner"></div>
            <div class="loading-text">正在生成驗證報告...</div>
        </div>
    </div>

    <!-- JavaScript文件 -->
    <script src="script.js"></script>
    <script>
        // 賽後分析頁面邏輯
        document.addEventListener('DOMContentLoaded', function() {
            console.log('賽後分析頁面加載完成');
            
            // 初始化
            loadPendingMatches();
            
            // 事件監聽
            document.getElementById('submitResults').addEventListener('click', submitResults);
            document.getElementById('saveVerification').addEventListener('click', saveVerification);
            document.getElementById('copyCode').addEventListener('click', copyLazyCode);
            document.getElementById('applyUpdates').addEventListener('click', applyUpdates);
            document.getElementById('newVerification').addEventListener('click', newVerification);
            document.getElementById('downloadUpdatePackage').addEventListener('click', downloadUpdatePackage);
            
            // 檢查URL參數
            checkUrlParameters();
        });
        
        // 檢查URL參數
        function checkUrlParameters() {
            const urlParams = new URLSearchParams(window.location.search);
            const autoProcess = urlParams.get('auto');
            
            if (autoProcess === 'fb3200') {
                setTimeout(() => {
                    autoProcessFB3200();
                }, 1000);
            }
        }
        
        // 載入待驗證比賽
        async function loadPendingMatches() {
            try {
                // 從webDataManager獲取數據
                const matches = webDataManager ? webDataManager.get('matches') : [];
                
                // 過濾出待驗證的比賽
                const pendingMatches = matches.filter(match => match.status === 'pending');
                
                const matchGrid = document.getElementById('matchGrid');
                matchGrid.innerHTML = '';
                
                if (pendingMatches.length === 0) {
                    document.getElementById('noMatches').style.display = 'block';
                    return;
                }
                
                pendingMatches.forEach(match => {
                    const matchCard = document.createElement('div');
                    matchCard.className = `match-card ${match.status}`;
                    matchCard.dataset.matchId = match.matchId;
                    matchCard.dataset.matchData = JSON.stringify(match);
                    
                    const predictionParts = match.prediction ? match.prediction.split('|') : ['', '', '', '', ''];
                    
                    matchCard.innerHTML = `
                        <div class="match-id">
                            ${match.matchId}
                            <span class="match-status status-${match.status}">
                                ${match.status === 'pending' ? '待驗證' : '已驗證'}
                            </span>
                        </div>
                        <div class="match-teams">${match.homeTeam} vs ${match.awayTeam}</div>
                        <div class="match-time">${match.matchTime}</div>
                        <div class="match-prediction">
                            <small>預測: ${predictionParts[0] || '無預測'} (${predictionParts[1] || '0'}%)</small>
                        </div>
                    `;
                    
                    matchCard.addEventListener('click', function() {
                        selectMatch(match);
                    });
                    
                    matchGrid.appendChild(matchCard);
                });
                
            } catch (error) {
                console.error('載入比賽時出錯:', error);
                systemUtils.showAlert('載入失敗', '無法載入比賽數據', 'error');
            }
        }
        
        // 選擇比賽
        function selectMatch(match) {
            // 移除所有選中狀態
            document.querySelectorAll('.match-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // 添加選中狀態
            const selectedCard = document.querySelector(`[data-match-id="${match.matchId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // 顯示選中比賽信息
            document.getElementById('selectedMatchInfo').style.display = 'block';
            document.getElementById('selectedMatchId').textContent = match.matchId;
            document.getElementById('selectedMatchTeams').textContent = `${match.homeTeam} vs ${match.awayTeam}`;
            document.getElementById('selectedMatchTime').textContent = match.matchTime;
            
            // 啟用提交按鈕
            document.getElementById('submitResults').disabled = false;
            
            // 保存選中比賽到全局變量
            window.selectedMatch = match;
        }
        
        // 提交結果
        async function submitResults() {
            if (!window.selectedMatch) {
                systemUtils.showAlert('錯誤', '請先選擇比賽', 'error');
                return;
            }
            
            // 驗證輸入
            const halfHomeScore = parseInt(document.getElementById('halfHomeScore').value);
            const halfAwayScore = parseInt(document.getElementById('halfAwayScore').value);
            const fullHomeScore = parseInt(document.getElementById('fullHomeScore').value);
            const fullAwayScore = parseInt(document.getElementById('fullAwayScore').value);
            
            if (isNaN(halfHomeScore) || isNaN(halfAwayScore) || 
                isNaN(fullHomeScore) || isNaN(fullAwayScore)) {
                systemUtils.showAlert('錯誤', '請輸入有效的比分', 'error');
                return;
            }
            
            // 顯示加載動畫
            document.getElementById('loadingOverlay').style.display = 'flex';
            
            try {
                // 使用webDataManager處理結果
                const matchId = window.selectedMatch.matchId;
                const prediction = parsePrediction(window.selectedMatch.prediction);
                
                const actual = {
                    matchId,
                    outcome: getOutcomeFromScore(fullHomeScore, fullAwayScore),
                    halfScore: `${halfHomeScore}:${halfAwayScore}`,
                    fullScore: `${fullHomeScore}:${fullAwayScore}`,
                    corners: document.getElementById('cornerData').value,
                    cards: extractCardsFromTechnique(document.getElementById('techniqueData').value),
                    possession: extractPossessionFromTechnique(document.getElementById('techniqueData').value)
                };
                
                // 計算準確度
                const accuracy = calculateAccuracy(prediction, actual);
                
                // 保存結果到LocalStorage
                webDataManager.updateResult(matchId, {
                    matchId,
                    homeScore: fullHomeScore,
                    awayScore: fullAwayScore,
                    halfHomeScore,
                    halfAwayScore,
                    halfCorners: extractCornerCount(actual.corners),
                    fullCorners: extractCornerCount(actual.corners),
                    techniqueData: document.getElementById('techniqueData').value,
                    verificationTime: new Date().toISOString(),
                    accuracy
                });
                
                // 生成懶人指令包
                const lazyPackage = webDataManager.generateLazyPackage(matchId, prediction, actual, accuracy);
                
                // 顯示結果
                displayVerificationResults({
                    matchId,
                    prediction,
                    results: actual,
                    verification: { 
                        accuracy,
                        isDirectionCorrect: checkDirectionCorrect(prediction.outcome, actual.outcome),
                        isCornersCorrect: checkCornersCorrect(prediction.corners, actual.corners),
                        isCardsCorrect: checkCardsCorrect(prediction.cards, actual.cards),
                        isPossessionCorrect: checkPossessionCorrect(prediction.possession, actual.possession)
                    },
                    lazyPackage
                });
                
                // 顯示下載更新包按鈕
                document.getElementById('downloadUpdatePackage').style.display = 'block';
                
                // 保存更新包到全局變量
                window.currentUpdatePackage = generateDeepSeekUpdatePackage(lazyPackage);
                
                systemUtils.showAlert('處理完成', `已生成驗證報告，準確度: ${accuracy}%`, 'success');
                
            } catch (error) {
                console.error('處理賽果時出錯:', error);
                systemUtils.showAlert('處理錯誤', '處理賽果時出現錯誤', 'error');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }
        
        // 解析預測字符串
        function parsePrediction(predictionStr) {
            if (!predictionStr) {
                return {
                    outcome: '',
                    probability: 0,
                    corners: '',
                    cards: '',
                    possession: ''
                };
            }
            
            const parts = predictionStr.split('|');
            return {
                outcome: parts[0] || '',
                probability: parseInt(parts[1]) || 0,
                corners: parts[2] || '',
                cards: parts[3] || '',
                possession: parts[4] || ''
            };
        }
        
        // 從技術分析數據提取黃牌數
        function extractCardsFromTechnique(techniqueData) {
            if (!techniqueData) return '0';
            
            const lines = techniqueData.split('\n');
            for (const line of lines) {
                if (line.includes('黃牌')) {
                    const parts = line.split(':');
                    if (parts.length === 2) {
                        const cards = parts[1].split('-');
                        if (cards.length === 2) {
                            return String(parseInt(cards[0]) + parseInt(cards[1]));
                        }
                    }
                }
            }
            return '0';
        }
        
        // 從技術分析數據提取控球率
        function extractPossessionFromTechnique(techniqueData) {
            if (!techniqueData) return '50%:50%';
            
            const lines = techniqueData.split('\n');
            for (const line of lines) {
                if (line.includes('控球率')) {
                    const parts = line.split(':');
                    if (parts.length === 2) {
                        const possession = parts[1].split('-');
                        if (possession.length === 2) {
                            return `${possession[0]}%:${possession[1]}%`;
                        }
                    }
                }
            }
            return '50%:50%';
        }
        
        // 從角球字符串提取數量
        function extractCornerCount(cornerStr) {
            if (!cornerStr) return '0';
            
            const match = cornerStr.match(/\d+/);
            return match ? match[0] : '0';
        }
        
        // 根據比分判斷賽果
        function getOutcomeFromScore(homeScore, awayScore) {
            if (homeScore > awayScore) {
                return '主隊勝';
            } else if (homeScore < awayScore) {
                return '客隊勝';
            } else {
                return '平局';
            }
        }
        
        // 計算準確度
        function calculateAccuracy(prediction, actual) {
            let score = 0;
            
            // 賽果方向準確度 (40%)
            const directionCorrect = checkDirectionCorrect(prediction.outcome, actual.outcome);
            if (directionCorrect) score += 40;
            
            // 角球準確度 (20%)
            const cornersCorrect = checkCornersCorrect(prediction.corners, actual.corners);
            if (cornersCorrect) score += 20;
            
            // 黃牌準確度 (20%)
            const cardsCorrect = checkCardsCorrect(prediction.cards, actual.cards);
            if (cardsCorrect) score += 20;
            
            // 控球率準確度 (20%)
            const possessionCorrect = checkPossessionCorrect(prediction.possession, actual.possession);
            if (possessionCorrect) score += 20;
            
            return score;
        }
        
        // 檢查方向準確度
        function checkDirectionCorrect(predictedOutcome, actualOutcome) {
            if (!predictedOutcome || !actualOutcome) return false;
            
            const predicted = predictedOutcome.toLowerCase();
            const actual = actualOutcome.toLowerCase();
            
            if (predicted.includes('主') && actual.includes('主')) return true;
            if (predicted.includes('客') && actual.includes('客')) return true;
            if (predicted.includes('平') && actual.includes('平')) return true;
            if (predicted.includes('和') && actual.includes('和')) return true;
            
            return false;
        }
        
        // 檢查角球準確度
        function checkCornersCorrect(predictedCorners, actualCorners) {
            if (!predictedCorners || !actualCorners) return false;
            
            const predictedRange = predictedCorners.replace('個', '').split('-');
            if (predictedRange.length !== 2) return false;
            
            const predictedMin = parseInt(predictedRange[0]);
            const predictedMax = parseInt(predictedRange[1]);
            const actualCount = parseInt(extractCornerCount(actualCorners));
            
            return actualCount >= predictedMin && actualCount <= predictedMax;
        }
        
        // 檢查黃牌準確度
        function checkCardsCorrect(predictedCards, actualCards) {
            if (!predictedCards || !actualCards) return false;
            
            const predictedRange = predictedCards.replace('張', '').split('-');
            if (predictedRange.length !== 2) return false;
            
            const predictedMin = parseInt(predictedRange[0]);
            const predictedMax = parseInt(predictedRange[1]);
            const actualCount = parseInt(actualCards);
            
            return actualCount >= predictedMin && actualCount <= predictedMax;
        }
        
        // 檢查控球率準確度
        function checkPossessionCorrect(predictedPossession, actualPossession) {
            if (!predictedPossession || !actualPossession) return false;
            
            const predictedParts = predictedPossession.split(':');
            const actualParts = actualPossession.split(':');
            
            if (predictedParts.length !== 2 || actualParts.length !== 2) return false;
            
            const predictedHome = parseInt(predictedParts[0].replace('%', ''));
            const actualHome = parseInt(actualParts[0].replace('%', ''));
            
            // 允許±5%的誤差
            return Math.abs(predictedHome - actualHome) <= 5;
        }
        
        // 生成DeepSeek更新包
        function generateDeepSeekUpdatePackage(lazyPackage) {
            const updatePackage = {
                type: 'system_update',
                version: 'V6.1',
                timestamp: new Date().toISOString(),
                matchId: lazyPackage.matchId,
                accuracy: lazyPackage.accuracy,
                issues: lazyPackage.issues,
                recommendations: lazyPackage.recommendations,
                codeUpdates: lazyPackage.codeUpdates,
                fullData: webDataManager.exportAllData()
            };
            
            return updatePackage;
        }
        
        // 下載更新包
        function downloadUpdatePackage() {
            if (!window.currentUpdatePackage) {
                systemUtils.showAlert('錯誤', '無更新包可下載', 'error');
                return;
            }
            
            const jsonStr = JSON.stringify(window.currentUpdatePackage, null, 2);
            const blob = new Blob([jsonStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `己土系統更新包_${window.currentUpdatePackage.matchId}_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            systemUtils.showAlert('下載成功', '更新包已下載，可提供給DeepSeek進行系統升級', 'success');
        }
        
        // 顯示驗證結果
        function displayVerificationResults(report) {
            // 準確度指標
            const metricsHtml = `
                <div class="metric-card direction">
                    <div class="metric-label">方向準確度</div>
                    <div class="metric-value ${report.verification.isDirectionCorrect ? 'correct' : 'incorrect'}">
                        ${report.verification.isDirectionCorrect ? '100%' : '0%'}
                    </div>
                    <div class="metric-status ${report.verification.isDirectionCorrect ? 'status-correct' : 'status-incorrect'}">
                        ${report.verification.isDirectionCorrect ? '正確' : '錯誤'}
                    </div>
                </div>
                <div class="metric-card corners">
                    <div class="metric-label">角球準確度</div>
                    <div class="metric-value ${report.verification.isCornersCorrect ? 'correct' : 'incorrect'}">
                        ${report.verification.isCornersCorrect ? '100%' : '0%'}
                    </div>
                    <div class="metric-status ${report.verification.isCornersCorrect ? 'status-correct' : 'status-incorrect'}">
                        ${report.verification.isCornersCorrect ? '正確' : '錯誤'}
                    </div>
                </div>
                <div class="metric-card cards">
                    <div class="metric-label">黃牌準確度</div>
                    <div class="metric-value ${report.verification.isCardsCorrect ? 'correct' : 'incorrect'}">
                        ${report.verification.isCardsCorrect ? '100%' : '0%'}
                    </div>
                    <div class="metric-status ${report.verification.isCardsCorrect ? 'status-correct' : 'status-incorrect'}">
                        ${report.verification.isCardsCorrect ? '正確' : '錯誤'}
                    </div>
                </div>
                <div class="metric-card possession">
                    <div class="metric-label">控球率準確度</div>
                    <div class="metric-value ${report.verification.isPossessionCorrect ? 'correct' : 'incorrect'}">
                        ${report.verification.isPossessionCorrect ? '100%' : '0%'}
                    </div>
                    <div class="metric-status ${report.verification.isPossessionCorrect ? 'status-correct' : 'status-incorrect'}">
                        ${report.verification.isPossessionCorrect ? '正確' : '錯誤'}
                    </div>
                </div>
            `;
            
            document.getElementById('accuracyMetrics').innerHTML = metricsHtml;
            
            // 比較表格
            const comparisonHtml = `
                <tr>
                    <td>比賽結果</td>
                    <td class="prediction-col">${report.prediction.outcome || '無預測'}</td>
                    <td class="actual-col">${report.results.outcome}</td>
                    <td>${report.verification.isDirectionCorrect ? '✅' : '❌'}</td>
                </tr>
                <tr>
                    <td>角球數</td>
                    <td class="prediction-col">${report.prediction.corners || '無預測'}</td>
                    <td class="actual-col">${report.results.corners}</td>
                    <td>${report.verification.isCornersCorrect ? '✅' : '❌'}</td>
                </tr>
                <tr>
                    <td>黃牌數</td>
                    <td class="prediction-col">${report.prediction.cards || '無預測'}</td>
                    <td class="actual-col">${report.results.cards}張</td>
                    <td>${report.verification.isCardsCorrect ? '✅' : '❌'}</td>
                </tr>
                <tr>
                    <td>控球率</td>
                    <td class="prediction-col">${report.prediction.possession || '無預測'}</td>
                    <td class="actual-col">${report.results.possession}</td>
                    <td>${report.verification.isPossessionCorrect ? '✅' : '❌'}</td>
                </tr>
            `;
            
            document.getElementById('comparisonBody').innerHTML = comparisonHtml;
            
            // 技術分析詳情
            const techniqueData = document.getElementById('techniqueData').value;
            const techniqueLines = techniqueData.split('\n').filter(line => line.trim());
            
            let techniqueHtml = '';
            techniqueLines.forEach(line => {
                const parts = line.split(':');
                if (parts.length === 2) {
                    const label = parts[0];
                    const values = parts[1].split('-');
                    if (values.length === 2) {
                        techniqueHtml += `
                            <div class="technique-item">
                                <div class="technique-label">
                                    <i class="fas fa-chart-bar"></i> ${label}
                                </div>
                                <div class="technique-values">
                                    <span class="technique-value technice-home">${values[0]}</span>
                                    <span class="technique-diff">vs</span>
                                    <span class="technique-value technice-away">${values[1]}</span>
                                </div>
                            </div>
                        `;
                    }
                }
            });
            
            document.getElementById('techniqueDetails').innerHTML = techniqueHtml || '<p>無技術分析數據</p>';
            
            // 懶人指令包
            document.getElementById('packageId').textContent = report.lazyPackage.packageId;
            document.getElementById('generateTime').textContent = new Date(report.lazyPackage.generateTime).toLocaleString('zh-Hant');
            document.getElementById('lazyMatchId').textContent = report.lazyPackage.matchId;
            
            const instructionsHtml = report.lazyPackage.instructions ? report.lazyPackage.instructions.map(inst => `
                <div class="instruction-item ${inst.severity || 'suggestion'}">
                    <div class="instruction-icon ${inst.severity || 'suggestion'}">
                        <i class="fas fa-${inst.severity === 'high' ? 'exclamation-triangle' : 
                                         inst.severity === 'medium' ? 'exclamation-circle' : 'lightbulb'}"></i>
                    </div>
                    <div class="instruction-content">
                        <h4>${inst.title || inst.description || '建議'}</h4>
                        <p>${inst.description || inst.reason || ''}</p>
                        <small><strong>建議操作:</strong> ${inst.action || inst.suggestedChange || ''}</small>
                    </div>
                </div>
            `).join('') : '<p>無優化建議</p>';
            
            document.getElementById('instructionList').innerHTML = instructionsHtml;
            
            const codeUpdates = report.lazyPackage.codeUpdates || [];
            const codeText = codeUpdates.map(update => update.change || '').join('\n');
            
            document.getElementById('lazyCode').innerHTML = `// 懶人指令包 - AI參數優化代碼
// 生成時間: ${new Date().toLocaleString('zh-Hant')}
// 比賽ID: ${report.lazyPackage.matchId}
// 整體準確度: ${report.verification.accuracy}%

// 請複製以下代碼到 ai_parameters.csv 或相應JS文件中執行

${codeText || '// 當前參數表現良好，無需調整'}`;
            
            // 顯示驗證結果區域
            document.getElementById('verificationResults').style.display = 'block';
            
            // 保存報告到全局變量
            window.currentReport = report;
        }
        
        // 保存驗證報告
        async function saveVerification() {
            if (!window.currentReport) {
                systemUtils.showAlert('錯誤', '無驗證報告可保存', 'error');
                return;
            }
            
            try {
                // 更新比賽狀態
                webDataManager.updateMatchStatus(window.currentReport.matchId, 'completed');
                
                systemUtils.showAlert('保存成功', '驗證報告已保存，比賽狀態已更新', 'success');
                
            } catch (error) {
                console.error('保存失敗:', error);
                systemUtils.showAlert('保存失敗', '保存報告時出現錯誤', 'error');
            }
        }
        
        // 複製懶人指令代碼
        function copyLazyCode() {
            const codeElement = document.getElementById('lazyCode');
            const codeText = codeElement.textContent || codeElement.innerText;
            
            navigator.clipboard.writeText(codeText)
                .then(() => {
                    systemUtils.showAlert('複製成功', '代碼已複製到剪貼板', 'success');
                })
                .catch(err => {
                    console.error('複製失敗:', err);
                    systemUtils.showAlert('複製失敗', '無法複製代碼', 'error');
                });
        }
        
        // 應用更新
        function applyUpdates() {
            const confirmApply = confirm('確定要應用這些參數更新嗎？\n這將會修改當前的AI參數體系。');
            if (confirmApply) {
                try {
                    // 應用代碼更新
                    if (window.currentReport && window.currentReport.lazyPackage.codeUpdates) {
                        window.currentReport.lazyPackage.codeUpdates.forEach(update => {
                            if (update.parameter && update.file === 'ai_parameters.csv') {
                                const newValue = parseFloat(update.change.split(',')[3]);
                                webDataManager.updateAIParameter(update.parameter, newValue, `基於${window.currentReport.matchId}調整`);
                            }
                        });
                        
                        systemUtils.showAlert('應用成功', '參數更新已應用到系統', 'success');
                    }
                } catch (error) {
                    systemUtils.showAlert('應用錯誤', '應用更新時出現錯誤', 'error');
                }
            }
        }
        
        // 新驗證
        function newVerification() {
            const confirmNew = confirm('開始新的驗證將會重置當前表單，確定嗎？');
            if (confirmNew) {
                // 重置表單
                document.getElementById('halfHomeScore').value = '0';
                document.getElementById('halfAwayScore').value = '0';
                document.getElementById('fullHomeScore').value = '0';
                document.getElementById('fullAwayScore').value = '0';
                document.getElementById('cornerData').value = '';
                document.getElementById('techniqueData').value = '';
                
                // 隱藏結果區域
                document.getElementById('verificationResults').style.display = 'none';
                document.getElementById('selectedMatchInfo').style.display = 'none';
                document.getElementById('downloadUpdatePackage').style.display = 'none';
                
                // 禁用提交按鈕
                document.getElementById('submitResults').disabled = true;
                
                // 重置選中比賽
                window.selectedMatch = null;
                document.querySelectorAll('.match-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                systemUtils.showAlert('表單已重置', '可以開始新的驗證', 'info');
            }
        }
        
        // 自動處理FB3200賽果
        function autoProcessFB3200() {
            console.log('自動處理FB3200賽果...');
            
            // 檢查是否有FB3200比賽
            const matches = webDataManager ? webDataManager.get('matches') : [];
            const fb3200Match = matches.find(m => m.matchId === 'FB3200');
            
            if (!fb3200Match) {
                systemUtils.showAlert('錯誤', '找不到FB3200比賽，請先確保已進行賽前預測', 'error');
                return;
            }
            
            // 自動選擇FB3200比賽
            selectMatch(fb3200Match);
            
            // 設置實際賽果數據（根據您提供的數據）
            const resultData = {
                halfHomeScore: 0,
                halfAwayScore: 1,
                fullHomeScore: 0,
                fullAwayScore: 1,
                cornerData: '5 (4:1)',
                techniqueData: `進攻:124-73
黃牌:0-1
射正:4-2
紅牌:0-0
危險進攻:53-25
射斜:5-4
控球率:65-35
角球:7-3
點球:0-0
被擋掉射門:4-2`
            };
            
            // 自動填入表單
            document.getElementById('halfHomeScore').value = resultData.halfHomeScore;
            document.getElementById('halfAwayScore').value = resultData.halfAwayScore;
            document.getElementById('fullHomeScore').value = resultData.fullHomeScore;
            document.getElementById('fullAwayScore').value = resultData.fullAwayScore;
            document.getElementById('cornerData').value = resultData.cornerData;
            document.getElementById('techniqueData').value = resultData.techniqueData;
            
            systemUtils.showAlert('自動填寫', '已自動填入FB3200賽果數據', 'info');
            
            // 3秒後自動提交
            setTimeout(() => {
                document.getElementById('submitResults').click();
            }, 3000);
        }
    </script>
</body>
</html>