<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分析報告 - 陰盤奇門足球AI預測系統</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 分析報告專用樣式 */
        .report-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        .report-title {
            font-size: 2.2em;
            margin-bottom: 10px;
            color: white;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .report-subtitle {
            font-size: 1.2em;
            opacity: 0.9;
            margin-bottom: 20px;
        }
        
        .report-meta {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            font-size: 0.95em;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .meta-item i {
            color: #3498db;
        }
        
        .prediction-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border: 3px solid #3498db;
            position: relative;
            overflow: hidden;
        }
        
        .prediction-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, #3498db, #2ecc71, #e74c3c);
        }
        
        .prediction-title {
            font-size: 1.8em;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .prediction-title i {
            font-size: 1.5em;
            color: #3498db;
        }
        
        .probability-display {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .probability-item {
            background: white;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            border: 2px solid transparent;
        }
        
        .probability-item:hover {
            transform: translateY(-5px);
        }
        
        .probability-item.home {
            border-color: #3498db;
        }
        
        .probability-item.draw {
            border-color: #f39c12;
        }
        
        .probability-item.away {
            border-color: #e74c3c;
        }
        
        .probability-label {
            font-size: 1.1em;
            font-weight: 600;
            margin-bottom: 10px;
            color: #2c3e50;
        }
        
        .probability-value {
            font-size: 3em;
            font-weight: 700;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .probability-bar-container {
            height: 20px;
            background: #ecf0f1;
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .probability-bar {
            height: 100%;
            border-radius: 10px;
            transition: width 1.5s ease-in-out;
        }
        
        .recommendation-box {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            margin-top: 20px;
            box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3); }
            50% { box-shadow: 0 8px 30px rgba(46, 204, 113, 0.5); }
            100% { box-shadow: 0 8px 20px rgba(46, 204, 113, 0.3); }
        }
        
        .recommendation-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .recommendation-bet {
            font-size: 2.5em;
            font-weight: 700;
            margin: 15px 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .confidence-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }
        
        .section-divider {
            height: 2px;
            background: linear-gradient(90deg, transparent, #3498db, transparent);
            margin: 40px 0;
        }
        
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .pattern-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border-left: 5px solid;
            transition: transform 0.3s ease;
        }
        
        .pattern-card:hover {
            transform: translateY(-3px);
        }
        
        .pattern-card.good {
            border-left-color: #2ecc71;
        }
        
        .pattern-card.bad {
            border-left-color: #e74c3c;
        }
        
        .pattern-card.neutral {
            border-left-color: #f39c12;
        }
        
        .pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .pattern-name {
            font-size: 1.2em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .pattern-type {
            background: #ecf0f1;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .pattern-description {
            color: #7f8c8d;
            font-size: 0.95em;
            line-height: 1.6;
        }
        
        .raw-data-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid #e0e0e0;
        }
        
        .raw-data-title {
            font-size: 1.3em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .raw-data-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            font-family: 'Microsoft JhengHei', 'Segoe UI', sans-serif;
            font-size: 1.05em;
            line-height: 1.8;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }
        
        .raw-data-content code {
            background: #f1f8ff;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #2c3e50;
        }
        
        .action-buttons {
            position: sticky;
            bottom: 0;
            background: white;
            padding: 20px;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
            border-top: 2px solid #3498db;
            z-index: 100;
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        @media (max-width: 768px) {
            .probability-display {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .probability-value {
                font-size: 2.5em;
            }
            
            .pattern-grid {
                grid-template-columns: 1fr;
            }
            
            .report-header {
                padding: 20px;
            }
            
            .report-title {
                font-size: 1.8em;
            }
            
            .recommendation-bet {
                font-size: 2em;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-spinner-large {
            font-size: 3em;
            color: #3498db;
            margin-bottom: 20px;
        }
        
        .loading-text {
            font-size: 1.2em;
            color: #2c3e50;
            text-align: center;
        }
        
        .time-analysis {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .time-period {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            border: 2px solid;
        }
        
        .time-period.first-half {
            border-color: #3498db;
        }
        
        .time-period.second-half {
            border-color: #9b59b6;
        }
        
        .time-period-title {
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .time-probabilities {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            text-align: center;
        }
        
        .time-prob-item {
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .time-prob-item.home {
            background: rgba(52, 152, 219, 0.1);
            color: #2980b9;
        }
        
        .time-prob-item.draw {
            background: rgba(243, 156, 18, 0.1);
            color: #d68910;
        }
        
        .time-prob-item.away {
            background: rgba(231, 76, 60, 0.1);
            color: #c0392b;
        }
        
        .quick-actions {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }
        
        .quick-actions .btn {
            flex: 1;
            min-width: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 頂部導航 -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-futbol"></i>
                <span>陰盤奇門足球AI預測系統 V5.2</span>
            </div>
            <div class="nav-menu">
                <a href="index.html"><i class="fas fa-home"></i> 儀表板</a>
                <a href="match_input.html"><i class="fas fa-plus-circle"></i> 輸入比賽</a>
                <a href="analysis_view.html" class="active"><i class="fas fa-chart-bar"></i> 分析報告</a>
                <a href="result_verification.html"><i class="fas fa-check-circle"></i> 賽果驗證</a>
                <a href="pattern_library.html"><i class="fas fa-book"></i> 格局庫</a>
                <a href="system_status.html"><i class="fas fa-server"></i> 系統狀態</a>
                <a href="update_instructions.html"><i class="fas fa-code-branch"></i> 更新指令</a>
            </div>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </nav>

        <!-- 加載遮罩 -->
        <div id="loading-overlay" class="loading-overlay" style="display: none;">
            <i class="fas fa-spinner fa-spin loading-spinner-large"></i>
            <div class="loading-text">正在分析奇門數據...</div>
        </div>

        <!-- 主內容區 -->
        <main class="main-content">
            <!-- 報告標頭 -->
            <div class="report-header">
                <div class="report-title">
                    <i class="fas fa-chart-bar"></i>
                    <span id="report-title">奇門足球AI分析報告</span>
                </div>
                <div class="report-subtitle" id="report-subtitle">
                    基於陰盤奇門遁甲 V5.2 參數體系分析
                </div>
                <div class="report-meta">
                    <div class="meta-item">
                        <i class="fas fa-hashtag"></i>
                        <span>比賽編號：</span>
                        <strong id="match-code">--</strong>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-calendar-alt"></i>
                        <span>分析時間：</span>
                        <strong id="analysis-time">--</strong>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-cogs"></i>
                        <span>參數版本：</span>
                        <strong>V5.2</strong>
                    </div>
                    <div class="meta-item">
                        <i class="fas fa-bullseye"></i>
                        <span>歷史準確度：</span>
                        <strong>65.2%</strong>
                    </div>
                </div>
            </div>

            <!-- 主要預測結果 -->
            <div class="prediction-card">
                <div class="prediction-title">
                    <i class="fas fa-bullseye"></i>
                    核心預測結果
                </div>
                
                <!-- 概率顯示 -->
                <div class="probability-display">
                    <div class="probability-item home">
                        <div class="probability-label">主勝概率</div>
                        <div class="probability-value" id="home-prob">--%</div>
                        <div class="probability-bar-container">
                            <div class="probability-bar home-prob" id="home-prob-bar" style="width: 0%"></div>
                        </div>
                        <div class="probability-desc">主隊優勢指數</div>
                    </div>
                    
                    <div class="probability-item draw">
                        <div class="probability-label">和局概率</div>
                        <div class="probability-value" id="draw-prob">--%</div>
                        <div class="probability-bar-container">
                            <div class="probability-bar draw-prob" id="draw-prob-bar" style="width: 0%"></div>
                        </div>
                        <div class="probability-desc">平局可能性</div>
                    </div>
                    
                    <div class="probability-item away">
                        <div class="probability-label">客勝概率</div>
                        <div class="probability-value" id="away-prob">--%</div>
                        <div class="probability-bar-container">
                            <div class="probability-bar away-prob" id="away-prob-bar" style="width: 0%"></div>
                        </div>
                        <div class="probability-desc">客隊機會評估</div>
                    </div>
                </div>
                
                <!-- 時間分析 -->
                <div class="time-analysis">
                    <div class="time-period first-half">
                        <div class="time-period-title">
                            <i class="fas fa-clock"></i>
                            上半場趨勢
                        </div>
                        <div class="time-probabilities">
                            <div class="time-prob-item home">
                                主隊 <span id="first-half-home">--%</span>
                            </div>
                            <div class="time-prob-item draw">
                                和局 <span id="first-half-draw">--%</span>
                            </div>
                            <div class="time-prob-item away">
                                客隊 <span id="first-half-away">--%</span>
                            </div>
                        </div>
                        <div class="time-note" id="first-half-note">
                            時限性參數顯示上半場能量集中
                        </div>
                    </div>
                    
                    <div class="time-period second-half">
                        <div class="time-period-title">
                            <i class="fas fa-clock"></i>
                            下半場趨勢
                        </div>
                        <div class="time-probabilities">
                            <div class="time-prob-item home">
                                主隊 <span id="second-half-home">--%</span>
                            </div>
                            <div class="time-prob-item draw">
                                和局 <span id="second-half-draw">--%</span>
                            </div>
                            <div class="time-prob-item away">
                                客隊 <span id="second-half-away">--%</span>
                            </div>
                        </div>
                        <div class="time-note" id="second-half-note">
                            時效性參數顯示可能轉折
                        </div>
                    </div>
                </div>
                
                <!-- 推薦投注 -->
                <div class="recommendation-box">
                    <div class="recommendation-title">
                        <i class="fas fa-star"></i>
                        AI推薦投注
                    </div>
                    <div class="recommendation-bet" id="recommended-bet">--</div>
                    <div class="confidence-badge" id="confidence-level">
                        信心指數：<span id="confidence-value">--</span>%
                    </div>
                    <div class="recommendation-note" id="recommendation-note">
                        基於三維參數體系綜合分析
                    </div>
                </div>
            </div>

            <!-- 格局分析 -->
            <div class="section">
                <div class="section-header">
                    <h2><i class="fas fa-chess-board"></i> 奇門格局分析</h2>
                    <button type="button" class="btn btn-outline" onclick="togglePatternDetails()">
                        <i class="fas fa-expand"></i> 展開詳情
                    </button>
                </div>
                
                <!-- 關鍵格局 -->
                <h3><i class="fas fa-exclamation-circle"></i> 關鍵格局影響</h3>
                <div class="pattern-grid" id="pattern-grid">
                    <!-- 動態生成格局卡片 -->
                    <div class="pattern-card">
                        <div class="pattern-header">
                            <div class="pattern-name">載入中...</div>
                            <div class="pattern-type">--</div>
                        </div>
                        <div class="pattern-description">
                            正在分析奇門格局...
                        </div>
                    </div>
                </div>
                
                <!-- 能量分析 -->
                <h3><i class="fas fa-bolt"></i> 能量分析</h3>
                <div class="alert alert-info">
                    <div class="alert-icon">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="alert-content">
                        <h4 class="alert-title" id="energy-title">能量分析中...</h4>
                        <p class="alert-message" id="energy-description">
                            正在計算宮位能量分布...
                        </p>
                    </div>
                </div>
            </div>

            <!-- 技術預測 -->
            <div class="section">
                <div class="section-header">
                    <h2><i class="fas fa-football-ball"></i> 技術統計預測</h2>
                    <button type="button" class="btn btn-primary" onclick="showTechnicalDetails()">
                        <i class="fas fa-chart-bar"></i> 詳細數據
                    </button>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card warning">
                        <div class="stat-icon">
                            <i class="fas fa-clipboard"></i>
                        </div>
                        <div class="stat-content">
                            <h3>預計黃牌數</h3>
                            <p class="stat-value" id="yellow-cards">--</p>
                            <p class="stat-desc" id="yellow-cards-desc">基於傷門門迫算法</p>
                        </div>
                    </div>
                    
                    <div class="stat-card info">
                        <div class="stat-icon">
                            <i class="fas fa-basketball-ball"></i>
                        </div>
                        <div class="stat-content">
                            <h3>控球率預測</h3>
                            <p class="stat-value" id="possession">--%</p>
                            <p class="stat-desc" id="possession-desc">死門門迫影響顯著</p>
                        </div>
                    </div>
                    
                    <div class="stat-card success">
                        <div class="stat-icon">
                            <i class="fas fa-running"></i>
                        </div>
                        <div class="stat-content">
                            <h3>危險進攻</h3>
                            <p class="stat-value" id="dangerous-attacks">--</p>
                            <p class="stat-desc" id="dangerous-attacks-desc">九天吉神增強</p>
                        </div>
                    </div>
                    
                    <div class="stat-card primary">
                        <div class="stat-icon">
                            <i class="fas fa-flag"></i>
                        </div>
                        <div class="stat-content">
                            <h3>角球預測</h3>
                            <p class="stat-value" id="corners">--</p>
                            <p class="stat-desc" id="corners-desc">休門限制係數</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 原始數據 -->
            <div class="raw-data-section">
                <div class="raw-data-title">
                    <i class="fas fa-database"></i>
                    原始奇門數據
                </div>
                <div class="raw-data-content" id="raw-data-content">
                    正在載入原始數據...
                </div>
                
                <div class="quick-actions" style="margin-top: 20px;">
                    <button type="button" class="btn btn-outline" onclick="copyRawData()">
                        <i class="fas fa-copy"></i> 複製原始數據
                    </button>
                    <button type="button" class="btn btn-primary" onclick="saveRawData()">
                        <i class="fas fa-save"></i> 保存原始數據
                    </button>
                    <button type="button" class="btn btn-success" onclick="viewFullData()">
                        <i class="fas fa-expand"></i> 查看完整數據
                    </button>
                </div>
            </div>

            <!-- 快速操作 -->
            <div class="quick-actions" style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="goToVerification()">
                    <i class="fas fa-check-circle"></i> 進行賽果驗證
                </button>
                <button class="btn btn-success" onclick="goToUpdateInstructions()">
                    <i class="fas fa-code-branch"></i> 查看更新指令
                </button>
                <button class="btn btn-info" onclick="goToPatternLibrary()">
                    <i class="fas fa-book"></i> 查看格局庫
                </button>
            </div>

            <!-- 操作按鈕 -->
            <div class="action-buttons">
                <button type="button" class="btn btn-outline" onclick="window.print()">
                    <i class="fas fa-print"></i> 打印報告
                </button>
                <button type="button" class="btn btn-outline" onclick="saveAsPDF()">
                    <i class="fas fa-file-pdf"></i> 保存為PDF
                </button>
                <button type="button" class="btn btn-primary" onclick="shareReport()">
                    <i class="fas fa-share-alt"></i> 分享報告
                </button>
                <button type="button" class="btn btn-success" onclick="saveAnalysis()">
                    <i class="fas fa-save"></i> 保存分析結果
                </button>
            </div>
        </main>

        <!-- 底部資訊 -->
        <footer class="footer">
            <p>甲方己土玄學顧問公司 · AI陰盤奇門足球分析系統 V5.2</p>
            <p>報告時間：<span id="current-time"></span></p>
        </footer>
    </div>

    <!-- 技術詳情模態框 -->
    <div id="technical-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-bar"></i> 詳細技術預測</h3>
                <button class="modal-close" onclick="closeTechnicalModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="technical-details">
                    正在載入技術預測詳情...
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="closeTechnicalModal()">
                    關閉
                </button>
            </div>
        </div>
    </div>

    <!-- 完整數據模態框 -->
    <div id="full-data-modal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 90%; max-height: 90%;">
            <div class="modal-header">
                <h3><i class="fas fa-database"></i> 完整奇門數據</h3>
                <button class="modal-close" onclick="closeFullDataModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="full-data-content" style="max-height: 70vh; overflow-y: auto; font-family: 'Courier New', monospace; font-size: 0.9em; background: #2c3e50; color: #ecf0f1; padding: 20px; border-radius: 8px;">
                    正在載入完整數據...
                </pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" onclick="closeFullDataModal()">
                    關閉
                </button>
                <button type="button" class="btn btn-primary" onclick="copyFullData()">
                    <i class="fas fa-copy"></i> 複製完整數據
                </button>
            </div>
        </div>
    </div>

    <!-- 腳本 -->
    <script src="js/supabase-client.js"></script>
    <script src="js/qimen-engine.js"></script>
    <script src="js/ai-optimizer.js"></script>
    <script src="js/app.js"></script>
    <script>
        // 全局變量
        let currentMatchData = null;
        let currentAnalysis = null;
        let fullQimenData = null;
        
        // 更新時間顯示
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleString('zh-TW', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }
        
        setInterval(updateTime, 1000);
        updateTime();
        
        // 載入比賽數據和分析結果
        async function loadMatchAnalysis() {
            const loadingOverlay = document.getElementById('loading-overlay');
            loadingOverlay.style.display = 'flex';
            
            try {
                // 獲取URL參數
                const urlParams = new URLSearchParams(window.location.search);
                const matchCode = urlParams.get('match');
                const previewMode = urlParams.get('preview') === 'true';
                const rawMode = urlParams.get('raw') === 'true';
                
                if (matchCode) {
                    // 從localStorage載入比賽數據
                    await loadMatchFromStorage(matchCode, previewMode);
                } else {
                    // 檢查是否有最近輸入的比賽
                    const lastMatchCode = localStorage.getItem('last_match_code');
                    if (lastMatchCode) {
                        await loadMatchFromStorage(lastMatchCode, false);
                    } else {
                        // 顯示示例數據
                        await loadExampleData();
                    }
                }
                
                // 顯示分析時間
                document.getElementById('analysis-time').textContent = 
                    new Date().toLocaleString('zh-TW');
                
            } catch (error) {
                console.error('載入分析失敗:', error);
                showError('載入分析失敗：' + error.message);
                
                // 嘗試載入示例數據
                await loadExampleData();
            } finally {
                loadingOverlay.style.display = 'none';
            }
        }
        
        // 從本地存儲載入比賽數據
        async function loadMatchFromStorage(matchCode, previewMode = false) {
            try {
                // 從localStorage載入
                let matchData = null;
                
                if (previewMode) {
                    const previewData = localStorage.getItem('preview_data');
                    if (previewData) {
                        matchData = JSON.parse(previewData);
                    }
                } else {
                    const storedData = localStorage.getItem(`match_${matchCode}`);
                    if (storedData) {
                        matchData = JSON.parse(storedData);
                    }
                }
                
                if (matchData) {
                    currentMatchData = matchData;
                    fullQimenData = matchData.qimen_data || matchData;
                    
                    // 設置標題
                    const homeTeam = matchData.home_team || matchData.match_info?.home_team || '主隊';
                    const awayTeam = matchData.away_team || matchData.match_info?.away_team || '客隊';
                    
                    document.getElementById('report-title').textContent = 
                        `${homeTeam} vs ${awayTeam}`;
                    
                    const matchCodeDisplay = matchData.match_code || matchCode || '--';
                    document.getElementById('match-code').textContent = matchCodeDisplay;
                    
                    // 顯示原始數據
                    displayRawData(fullQimenData);
                    
                    if (matchData.prediction) {
                        // 有預測結果，直接顯示
                        currentAnalysis = {
                            prediction: matchData.prediction,
                            analysis_report: matchData.analysis_report || {}
                        };
                        displayAnalysisResults();
                    } else {
                        // 沒有預測結果，執行分析
                        await performAnalysis(fullQimenData);
                    }
                } else {
                    throw new Error('找不到比賽數據');
                }
            } catch (error) {
                console.error('載入比賽數據失敗:', error);
                throw error;
            }
        }
        
        // 載入示例數據
        async function loadExampleData() {
            document.getElementById('report-title').textContent = '示例分析報告';
            document.getElementById('match-code').textContent = 'EXAMPLE';
            
            // 使用FB3200示例數據
            const exampleData = {
                match_info: {
                    home_team: '馬德里CFF女足',
                    away_team: '特內里費女足',
                    competition_type: '女子西班牙盃',
                    match_time: '2026-02-05T02:00:00'
                },
                raw_text: {
                    global_info: `公曆：2026年2月5日2時0分
農曆：2025年12月18日 陽遁3局
四柱：丙午 庚寅 庚戌 丁丑
時空亡：甲戌旬  申酉空　馬星：亥
值符：天輔星  值使：杜門
問測者落宮為兌宮(西方)`,
                    additional_notes: '這是一個示例分析報告'
                },
                palaces: {
                    dui: {
                        name: '兌宮',
                        direction: '西方',
                        four_harm: '四害：空亡（深挖到坎宮）',
                        patterns: `乙天干臨：絕 位
天盤─ 乙
天盤寄宮─ 庚
地盤─ 壬
天盤＋天盤寄宮─ 乙 + 庚：日奇被刑
天盤＋地盤─ 乙 + 壬：日奇入地
天盤寄宮＋地盤─ 庚 + 壬：小格（移蕩格）
八門─ 杜門
八門+天盤─ 杜 + 乙：飛來橫禍(訴訟)
九星─ 天芮星
八神─ 太陰`
                    },
                    kan: {
                        name: '坎宮',
                        direction: '北方',
                        four_harm: '無四害',
                        patterns: `天盤─ 戊
地盤─ 癸
天盤＋地盤─ 戊 + 癸：青龍華蓋`
                    }
                }
            };
            
            fullQimenData = exampleData;
            displayRawData(exampleData);
            await performAnalysis(exampleData);
        }
        
        // 執行奇門分析
        async function performAnalysis(qimenData) {
            try {
                showLoadingMessage('正在分析奇門格局...');
                
                // 使用奇門引擎分析
                const analysisResult = await window.qimenEngine.analyzeMatch(qimenData);
                
                if (analysisResult.success) {
                    currentAnalysis = analysisResult;
                    
                    // 保存分析結果
                    if (currentMatchData && currentMatchData.match_code !== 'EXAMPLE') {
                        currentMatchData.prediction = analysisResult.prediction;
                        currentMatchData.analysis_report = analysisResult.analysis_report;
                        currentMatchData.analyzed_at = new Date().toISOString();
                        
                        // 保存到本地存儲
                        const matchCode = currentMatchData.match_code || 'local_' + Date.now();
                        localStorage.setItem(`match_${matchCode}`, JSON.stringify(currentMatchData));
                        localStorage.setItem('last_match_code', matchCode);
                    }
                    
                    // 顯示分析結果
                    displayAnalysisResults();
                    
                } else {
                    throw new Error(analysisResult.error || '分析失敗');
                }
            } catch (error) {
                console.error('分析執行失敗:', error);
                showError('分析執行失敗：' + error.message);
            }
        }
        
        // 顯示分析結果
        function displayAnalysisResults() {
            if (!currentAnalysis) return;
            
            const { prediction, analysis_report } = currentAnalysis;
            
            // 更新概率顯示
            updateProbabilityDisplay(prediction);
            
            // 更新時間分析
            updateTimeAnalysis(prediction);
            
            // 更新推薦投注
            updateRecommendation(prediction);
            
            // 更新格局分析
            updatePatternAnalysis(analysis_report);
            
            // 更新能量分析
            updateEnergyAnalysis(analysis_report);
            
            // 更新技術預測
            updateTechnicalPrediction(analysis_report);
        }
        
        // 更新概率顯示
        function updateProbabilityDisplay(prediction) {
            // 主概率
            document.getElementById('home-prob').textContent = `${prediction.home_probability}%`;
            document.getElementById('draw-prob').textContent = `${prediction.draw_probability}%`;
            document.getElementById('away-prob').textContent = `${prediction.away_probability}%`;
            
            // 動畫顯示概率條
            setTimeout(() => {
                document.getElementById('home-prob-bar').style.width = `${prediction.home_probability}%`;
                document.getElementById('draw-prob-bar').style.width = `${prediction.draw_probability}%`;
                document.getElementById('away-prob-bar').style.width = `${prediction.away_probability}%`;
            }, 100);
        }
        
        // 更新時間分析
        function updateTimeAnalysis(prediction) {
            if (prediction.first_half) {
                document.getElementById('first-half-home').textContent = `${prediction.first_half.home}%`;
                document.getElementById('first-half-draw').textContent = `${prediction.first_half.draw}%`;
                document.getElementById('first-half-away').textContent = `${prediction.first_half.away}%`;
            }
            
            if (prediction.second_half) {
                document.getElementById('second-half-home').textContent = `${prediction.second_half.home}%`;
                document.getElementById('second-half-draw').textContent = `${prediction.second_half.draw}%`;
                document.getElementById('second-half-away').textContent = `${prediction.second_half.away}%`;
            }
        }
        
        // 更新推薦投注
        function updateRecommendation(prediction) {
            document.getElementById('recommended-bet').textContent = prediction.recommended_bet;
            document.getElementById('confidence-value').textContent = prediction.confidence;
            
            // 根據信心等級設置顏色
            const confidenceBadge = document.getElementById('confidence-level');
            if (prediction.confidence >= 70) {
                confidenceBadge.style.background = 'rgba(46, 204, 113, 0.3)';
            } else if (prediction.confidence >= 50) {
                confidenceBadge.style.background = 'rgba(243, 156, 18, 0.3)';
            } else {
                confidenceBadge.style.background = 'rgba(231, 76, 60, 0.3)';
            }
        }
        
        // 更新格局分析
        function updatePatternAnalysis(analysis_report) {
            const patternGrid = document.getElementById('pattern-grid');
            patternGrid.innerHTML = '';
            
            if (analysis_report.key_patterns && analysis_report.key_patterns.length > 0) {
                analysis_report.key_patterns.forEach(pattern => {
                    const patternCard = document.createElement('div');
                    patternCard.className = `pattern-card ${pattern.type === '吉格' ? 'good' : pattern.type === '凶格' ? 'bad' : 'neutral'}`;
                    
                    patternCard.innerHTML = `
                        <div class="pattern-header">
                            <div class="pattern-name">${pattern.name}</div>
                            <div class="pattern-type">${pattern.type}</div>
                        </div>
                        <div class="pattern-description">
                            <strong>宮位：</strong>${pattern.palace || '未指定'}<br>
                            <strong>影響：</strong>${pattern.impact}<br>
                            ${pattern.description || ''}
                        </div>
                    `;
                    
                    patternGrid.appendChild(patternCard);
                });
            } else {
                patternGrid.innerHTML = `
                    <div class="pattern-card neutral">
                        <div class="pattern-header">
                            <div class="pattern-name">無明顯格局</div>
                            <div class="pattern-type">普通局</div>
                        </div>
                        <div class="pattern-description">
                            本局未發現明顯吉凶格局，建議參考概率分析和技術預測
                        </div>
                    </div>
                `;
            }
        }
        
        // 更新能量分析
        function updateEnergyAnalysis(analysis_report) {
            if (analysis_report.energy_analysis) {
                const energy = analysis_report.energy_analysis;
                document.getElementById('energy-title').textContent = 
                    `能量分析：${energy.total_energy}`;
                
                let description = '';
                if (energy.home_strength && energy.away_strength) {
                    description += `主隊能量：${energy.home_strength}，客隊能量：${energy.away_strength}`;
                }
                if (energy.conversion_possible) {
                    description += '，存在能量轉換可能';
                }
                
                document.getElementById('energy-description').textContent = description;
            }
        }
        
        // 更新技術預測
        function updateTechnicalPrediction(analysis_report) {
            if (analysis_report.technical_prediction) {
                const tech = analysis_report.technical_prediction;
                
                // 黃牌
                if (tech.yellow_cards) {
                    document.getElementById('yellow-cards').textContent = 
                        `${tech.yellow_cards.total}張`;
                    document.getElementById('yellow-cards-desc').textContent = 
                        `主${tech.yellow_cards.home}客${tech.yellow_cards.away}`;
                }
                
                // 控球率
                if (tech.possession) {
                    document.getElementById('possession').textContent = 
                        `${tech.possession.home}%`;
                    document.getElementById('possession-desc').textContent = 
                        `客隊${tech.possession.away}%`;
                }
                
                // 危險進攻
                if (tech.dangerous_attacks) {
                    document.getElementById('dangerous-attacks').textContent = 
                        `${tech.dangerous_attacks.total}次`;
                    document.getElementById('dangerous-attacks-desc').textContent = 
                        `主${tech.dangerous_attacks.home}客${tech.dangerous_attacks.away}`;
                }
                
                // 角球
                if (tech.corners) {
                    document.getElementById('corners').textContent = 
                        `${tech.corners.total}個`;
                    document.getElementById('corners-desc').textContent = 
                        `主${tech.corners.home}客${tech.corners.away}`;
                }
            }
        }
        
        // 顯示原始數據
        function displayRawData(qimenData) {
            let rawText = '';
            
            if (qimenData.match_info) {
                rawText += '=== 比賽資訊 ===\n';
                rawText += `主隊：${qimenData.match_info.home_team || '--'}\n`;
                rawText += `客隊：${qimenData.match_info.away_team || '--'}\n`;
                rawText += `賽事：${qimenData.match_info.competition_type || '--'}\n`;
                rawText += `時間：${qimenData.match_info.match_time || '--'}\n\n`;
            }
            
            if (qimenData.raw_text && qimenData.raw_text.global_info) {
                rawText += '=== 奇門全局資訊 ===\n';
                rawText += qimenData.raw_text.global_info + '\n\n';
            }
            
            if (qimenData.raw_text && qimenData.raw_text.additional_notes) {
                rawText += '=== 補充說明 ===\n';
                rawText += qimenData.raw_text.additional_notes + '\n\n';
            }
            
            if (qimenData.palaces) {
                rawText += '=== 各宮資訊 ===\n';
                Object.keys(qimenData.palaces).forEach(palaceKey => {
                    const palace = qimenData.palaces[palaceKey];
                    rawText += `\n【${palace.name} ${palace.direction}】\n`;
                    
                    if (palace.four_harm) {
                        rawText += palace.four_harm + '\n';
                    }
                    
                    if (palace.patterns) {
                        rawText += palace.patterns + '\n';
                    }
                });
            }
            
            document.getElementById('raw-data-content').textContent = rawText;
        }
        
        // 顯示完整數據
        function viewFullData() {
            if (!fullQimenData) return;
            
            const modal = document.getElementById('full-data-modal');
            const contentDiv = document.getElementById('full-data-content');
            
            contentDiv.textContent = JSON.stringify(fullQimenData, null, 2);
            modal.style.display = 'flex';
        }
        
        // 關閉完整數據模態框
        function closeFullDataModal() {
            document.getElementById('full-data-modal').style.display = 'none';
        }
        
        // 複製完整數據
        function copyFullData() {
            const content = document.getElementById('full-data-content').textContent;
            
            navigator.clipboard.writeText(content)
                .then(() => showNotification('success', '完整數據已複製到剪貼板'))
                .catch(() => showNotification('error', '複製失敗，請手動複製'));
        }
        
        // 複製原始數據
        function copyRawData() {
            const content = document.getElementById('raw-data-content').textContent;
            
            navigator.clipboard.writeText(content)
                .then(() => showNotification('success', '原始數據已複製到剪貼板'))
                .catch(() => showNotification('error', '複製失敗，請手動複製'));
        }
        
        // 保存原始數據
        function saveRawData() {
            const content = document.getElementById('raw-data-content').textContent;
            const matchCode = document.getElementById('match-code').textContent;
            const filename = `奇門數據_${matchCode}_${new Date().toISOString().slice(0, 10)}.txt`;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('success', `原始數據已保存為 ${filename}`);
        }
        
        // 保存分析結果
        function saveAnalysis() {
            if (!currentMatchData) return;
            
            const analysisData = {
                match_info: currentMatchData.match_info || {},
                prediction: currentAnalysis?.prediction || {},
                analysis_report: currentAnalysis?.analysis_report || {},
                raw_data: fullQimenData || {}
            };
            
            const matchCode = document.getElementById('match-code').textContent;
            const filename = `分析報告_${matchCode}_${new Date().toISOString().slice(0, 10)}.json`;
            
            const blob = new Blob([JSON.stringify(analysisData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('success', `分析報告已保存為 ${filename}`);
        }
        
        // 切換格局詳情
        function togglePatternDetails() {
            const patternGrid = document.getElementById('pattern-grid');
            const patternCards = patternGrid.querySelectorAll('.pattern-card');
            
            patternCards.forEach(card => {
                if (card.classList.contains('expanded')) {
                    card.classList.remove('expanded');
                    card.querySelector('.pattern-description').style.maxHeight = '60px';
                } else {
                    card.classList.add('expanded');
                    card.querySelector('.pattern-description').style.maxHeight = 'none';
                }
            });
        }
        
        // 顯示技術詳情
        function showTechnicalDetails() {
            const modal = document.getElementById('technical-modal');
            const detailsDiv = document.getElementById('technical-details');
            
            if (currentAnalysis && currentAnalysis.analysis_report && currentAnalysis.analysis_report.technical_prediction) {
                const tech = currentAnalysis.analysis_report.technical_prediction;
                
                let detailsHtml = `
                    <div class="stats-grid">
                        <div class="stat-card warning">
                            <div class="stat-icon">
                                <i class="fas fa-clipboard"></i>
                            </div>
                            <div class="stat-content">
                                <h3>黃牌預測</h3>
                                <p class="stat-value">${tech.yellow_cards?.total || '--'}張</p>
                                <p class="stat-desc">主隊：${tech.yellow_cards?.home || '--'}張</p>
                                <p class="stat-desc">客隊：${tech.yellow_cards?.away || '--'}張</p>
                            </div>
                        </div>
                        
                        <div class="stat-card info">
                            <div class="stat-icon">
                                <i class="fas fa-basketball-ball"></i>
                            </div>
                            <div class="stat-content">
                                <h3>控球率預測</h3>
                                <p class="stat-value">${tech.possession?.home || '--'}%</p>
                                <p class="stat-desc">客隊：${tech.possession?.away || '--'}%</p>
                                <p class="stat-desc">差值：${Math.abs((tech.possession?.home || 0) - (tech.possession?.away || 0))}%</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card success">
                            <div class="stat-icon">
                                <i class="fas fa-running"></i>
                            </div>
                            <div class="stat-content">
                                <h3>進攻數據</h3>
                                <p class="stat-value">${tech.dangerous_attacks?.total || '--'}次</p>
                                <p class="stat-desc">危險進攻</p>
                                <p class="stat-desc">射正：${tech.shots_on_target?.total || '--'}次</p>
                            </div>
                        </div>
                        
                        <div class="stat-card primary">
                            <div class="stat-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="stat-content">
                                <h3>角球預測</h3>
                                <p class="stat-value">${tech.corners?.total || '--'}個</p>
                                <p class="stat-desc">主隊：${tech.corners?.home || '--'}個</p>
                                <p class="stat-desc">客隊：${tech.corners?.away || '--'}個</p>
                            </div>
                        </div>
                    </div>
                `;
                
                detailsDiv.innerHTML = detailsHtml;
            } else {
                detailsDiv.innerHTML = '<p>暫無詳細技術預測數據</p>';
            }
            
            modal.style.display = 'flex';
        }
        
        // 關閉技術詳情模態框
        function closeTechnicalModal() {
            document.getElementById('technical-modal').style.display = 'none';
        }
        
        // 保存為PDF
        function saveAsPDF() {
            showNotification('info', 'PDF導出功能開發中...');
        }
        
        // 分享報告
        function shareReport() {
            if (navigator.share) {
                navigator.share({
                    title: '陰盤奇門足球AI分析報告',
                    text: `比賽分析：${currentMatchData?.home_team || ''} vs ${currentMatchData?.away_team || ''}`,
                    url: window.location.href
                });
            } else {
                // 複製鏈接到剪貼板
                navigator.clipboard.writeText(window.location.href)
                    .then(() => showNotification('success', '報告鏈接已複製到剪貼板'))
                    .catch(() => showNotification('error', '複製失敗'));
            }
        }
        
        // 前往賽果驗證
        function goToVerification() {
            if (currentMatchData && currentMatchData.match_code) {
                window.location.href = `result_verification.html?match=${currentMatchData.match_code}`;
            } else {
                const matchCode = document.getElementById('match-code').textContent;
                if (matchCode && matchCode !== '--') {
                    window.location.href = `result_verification.html?match=${matchCode}`;
                } else {
                    showNotification('warning', '請先保存比賽數據');
                }
            }
        }
        
        // 前往更新指令
        function goToUpdateInstructions() {
            if (currentMatchData && currentMatchData.match_code) {
                window.location.href = `update_instructions.html?match=${currentMatchData.match_code}`;
            } else {
                const matchCode = document.getElementById('match-code').textContent;
                if (matchCode && matchCode !== '--') {
                    window.location.href = `update_instructions.html?match=${matchCode}`;
                } else {
                    window.location.href = 'update_instructions.html';
                }
            }
        }
        
        // 前往格局庫
        function goToPatternLibrary() {
            if (currentMatchData && currentMatchData.match_code) {
                window.location.href = `pattern_library.html?match=${currentMatchData.match_code}`;
            } else {
                window.location.href = 'pattern_library.html';
            }
        }
        
        // 顯示加載消息
        function showLoadingMessage(message) {
            const loadingText = document.querySelector('.loading-text');
            if (loadingText) {
                loadingText.textContent = message;
            }
        }
        
        // 顯示錯誤
        function showError(message) {
            const patternGrid = document.getElementById('pattern-grid');
            patternGrid.innerHTML = `
                <div class="pattern-card bad">
                    <div class="pattern-header">
                        <div class="pattern-name">分析錯誤</div>
                        <div class="pattern-type">錯誤</div>
                    </div>
                    <div class="pattern-description">
                        ${message}
                    </div>
                </div>
            `;
            
            showNotification('error', message);
        }
        
        // 顯示通知
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : 
                                   type === 'error' ? 'exclamation-circle' : 
                                   type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // 自動移除
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 載入分析
            loadMatchAnalysis();
            
            // 移動端選單切換
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const navMenu = document.querySelector('.nav-menu');
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    navMenu.classList.toggle('active');
                });
            }
            
            // 點擊頁面其他地方關閉選單
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.nav-menu') && !e.target.closest('.mobile-menu-btn')) {
                    navMenu.classList.remove('active');
                }
            });
            
            // 點擊模態框外部關閉
            document.getElementById('technical-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('technical-modal')) {
                    closeTechnicalModal();
                }
            });
            
            document.getElementById('full-data-modal')?.addEventListener('click', (e) => {
                if (e.target === document.getElementById('full-data-modal')) {
                    closeFullDataModal();
                }
            });
        });
    </script>
</body>
</html>