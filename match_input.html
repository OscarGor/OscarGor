<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>比賽輸入 - 陰盤奇門足球AI預測系統</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <!-- 頂部導航 -->
        <nav class="navbar">
            <div class="nav-brand">
                <i class="fas fa-futbol"></i>
                <span>陰盤奇門足球AI預測系統 V5.2</span>
            </div>
            <div class="nav-menu">
                <a href="index.html"><i class="fas fa-home"></i> 儀表板</a>
                <a href="match_input.html" class="active"><i class="fas fa-plus-circle"></i> 輸入比賽</a>
                <a href="analysis_view.html"><i class="fas fa-chart-bar"></i> 分析報告</a>
                <a href="result_verification.html"><i class="fas fa-check-circle"></i> 賽果驗證</a>
                <a href="pattern_library.html"><i class="fas fa-book"></i> 格局庫</a>
                <a href="system_status.html"><i class="fas fa-server"></i> 系統狀態</a>
            </div>
            <div class="mobile-menu-btn">
                <i class="fas fa-bars"></i>
            </div>
        </nav>

        <!-- 主內容區 -->
        <main class="main-content">
            <div class="section">
                <div class="section-header">
                    <h2><i class="fas fa-plus-circle"></i> 比賽輸入</h2>
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="loadTemplate('FB3200')">
                            <i class="fas fa-magic"></i> 載入FB3200模板
                        </button>
                        <button type="button" class="btn btn-success" onclick="saveAsTemplate()">
                            <i class="fas fa-save"></i> 保存為模板
                        </button>
                    </div>
                </div>

                <!-- 表單 -->
                <form id="match-form">
                    <!-- 比賽基本信息 -->
                    <div class="form-section">
                        <h3><i class="fas fa-info-circle"></i> 比賽基本信息</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="match_code" class="form-label">比賽編號 <span class="required">*</span></label>
                                <input type="text" id="match_code" name="match_code" class="form-control" required placeholder="例如：FB3200">
                                <div class="form-help">
                                    <i class="fas fa-info-circle"></i> 唯一識別碼，建議格式：FB+數字
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="competition_type" class="form-label">賽事類別 <span class="required">*</span></label>
                                <select id="competition_type" name="competition_type" class="form-control" required>
                                    <option value="">請選擇賽事類別</option>
                                    <option value="女子西班牙盃">女子西班牙盃</option>
                                    <option value="阿根廷甲組聯賽">阿根廷甲組聯賽</option>
                                    <option value="荷蘭甲組聯賽">荷蘭甲組聯賽</option>
                                    <option value="德國乙組聯賽">德國乙組聯賽</option>
                                    <option value="澳洲職業聯賽">澳洲職業聯賽</option>
                                    <option value="阿聯酋職業聯賽">阿聯酋職業聯賽</option>
                                    <option value="巴西甲組聯賽">巴西甲組聯賽</option>
                                    <option value="歐洲聯賽冠軍盃">歐洲聯賽冠軍盃</option>
                                    <option value="沙特職業聯賽">沙特職業聯賽</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="home_team" class="form-label">主隊 <span class="required">*</span></label>
                                <input type="text" id="home_team" name="home_team" class="form-control" required placeholder="例如：馬德里CFF女足">
                            </div>
                            <div class="form-group">
                                <label for="away_team" class="form-label">客隊 <span class="required">*</span></label>
                                <input type="text" id="away_team" name="away_team" class="form-control" required placeholder="例如：特內里費女足">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="match_time" class="form-label">比賽時間 <span class="required">*</span></label>
                                <input type="datetime-local" id="match_time" name="match_time" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="timezone" class="form-label">時區</label>
                                <select id="timezone" name="timezone" class="form-control">
                                    <option value="UTC+8">UTC+8 (台灣/香港)</option>
                                    <option value="UTC+1" selected>UTC+1 (西班牙)</option>
                                    <option value="UTC+0">UTC+0 (英國)</option>
                                    <option value="UTC-3">UTC-3 (阿根廷)</option>
                                    <option value="UTC+10">UTC+10 (澳洲東部)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- 奇門全局資訊 -->
                    <div class="form-section">
                        <h3><i class="fas fa-yin-yang"></i> 奇門遁甲全局資訊</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="solar_date" class="form-label">公曆</label>
                                <input type="text" id="solar_date" name="solar_date" class="form-control" placeholder="例如：2026年2月5日2時0分">
                            </div>
                            <div class="form-group">
                                <label for="lunar_date" class="form-label">農曆</label>
                                <input type="text" id="lunar_date" name="lunar_date" class="form-control" placeholder="例如：2025年12月18日">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="yang_dun" class="form-label">陰陽遁</label>
                                <select id="yang_dun" name="yang_dun" class="form-control">
                                    <option value="陽遁">陽遁</option>
                                    <option value="陰遁">陰遁</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="dun_number" class="form-label">遁局數</label>
                                <input type="number" id="dun_number" name="dun_number" class="form-control" min="1" max="9" placeholder="1-9">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="four_pillars" class="form-label">四柱</label>
                                <input type="text" id="four_pillars" name="four_pillars" class="form-control" placeholder="例如：丙午 庚寅 庚戌 丁丑">
                            </div>
                            <div class="form-group">
                                <label for="kong_wang" class="form-label">時空亡</label>
                                <input type="text" id="kong_wang" name="kong_wang" class="form-control" placeholder="例如：甲戌旬 申酉空">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="horse_star" class="form-label">馬星</label>
                                <input type="text" id="horse_star" name="horse_star" class="form-control" placeholder="例如：亥">
                            </div>
                            <div class="form-group">
                                <label for="value_symbol" class="form-label">值符</label>
                                <input type="text" id="value_symbol" name="value_symbol" class="form-control" placeholder="例如：天輔星">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="value_door" class="form-label">值使</label>
                                <input type="text" id="value_door" name="value_door" class="form-control" placeholder="例如：杜門">
                            </div>
                            <div class="form-group">
                                <label for="asker_palace" class="form-label">問測者落宮</label>
                                <input type="text" id="asker_palace" name="asker_palace" class="form-control" placeholder="例如：兌宮(西方)">
                            </div>
                        </div>
                    </div>

                    <!-- 九宮詳細資訊 -->
                    <div class="form-section">
                        <h3><i class="fas fa-chess-board"></i> 九宮詳細資訊</h3>
                        
                        <!-- 兌宮 -->
                        <div class="palace-section">
                            <h4>兌宮（西方）</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">四害</label>
                                    <input type="text" name="dui_four_harm" class="form-control" placeholder="例如：空亡（深挖到坎宮）">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">天干臨位</label>
                                    <input type="text" name="dui_heavenly_stem" class="form-control" placeholder="例如：乙天干臨：絕 位">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">天盤</label>
                                    <input type="text" name="dui_sky_plate" class="form-control" placeholder="例如：乙">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">天盤寄宮</label>
                                    <input type="text" name="dui_sky_plate_host" class="form-control" placeholder="例如：庚">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">地盤</label>
                                    <input type="text" name="dui_ground_plate" class="form-control" placeholder="例如：壬">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">格局組合</label>
                                    <textarea name="dui_patterns" class="form-control" rows="2" placeholder="例如：乙+庚：日奇被刑，乙+壬：日奇入地，庚+壬：小格（移蕩格）"></textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">八門</label>
                                    <input type="text" name="dui_eight_door" class="form-control" placeholder="例如：杜門">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">八門組合</label>
                                    <input type="text" name="dui_door_sky" class="form-control" placeholder="例如：杜 + 乙：飛來橫禍(訴訟)">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">九星</label>
                                    <input type="text" name="dui_nine_star" class="form-control" placeholder="例如：天芮星">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">八神</label>
                                    <input type="text" name="dui_eight_god" class="form-control" placeholder="例如：太陰">
                                </div>
                            </div>
                        </div>

                        <!-- 其他宮位... (此處省略其他8宮的詳細代碼，結構相似) -->
                        <!-- 實際應用中應包含乾、坎、艮、震、巽、離、坤、中宮 -->

                        <div class="form-help">
                            <i class="fas fa-lightbulb"></i> 提示：每個宮位需填寫完整資訊以確保分析準確性
                        </div>
                    </div>

                    <!-- 表單操作 -->
                    <div class="form-actions">
                        <button type="button" class="btn btn-outline" onclick="resetForm()">
                            <i class="fas fa-undo"></i> 重置
                        </button>
                        <button type="button" class="btn btn-warning" onclick="previewAnalysis()">
                            <i class="fas fa-eye"></i> 預覽分析
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> 保存並分析
                        </button>
                    </div>
                </form>
            </div>
        </main>

        <!-- 底部資訊 -->
        <footer class="footer">
            <p>甲方己土玄學顧問公司 · AI陰盤奇門足球分析系統 V5.2</p>
            <p>報告時間：<span id="current-time"></span></p>
        </footer>
    </div>

    <!-- 腳本 -->
    <script src="js/supabase-client.js"></script>
    <script src="js/qimen-engine.js"></script>
    <script src="js/app.js"></script>
    <script>
        // 更新時間顯示
        function updateTime() {
            const now = new Date();
            document.getElementById('current-time').textContent = 
                now.toLocaleString('zh-TW', { 
                    year: 'numeric', 
                    month: '2-digit', 
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
        }
        
        setInterval(updateTime, 1000);
        updateTime();
        
        // 載入模板
        function loadTemplate(templateCode) {
            fetch('data/match_templates.json')
                .then(response => response.json())
                .then(templates => {
                    const template = templates[templateCode];
                    if (template) {
                        // 填充表單
                        Object.keys(template).forEach(key => {
                            const element = document.getElementById(key);
                            if (element) {
                                element.value = template[key];
                            }
                        });
                        
                        showNotification('success', `已載入${templateCode}模板`);
                    } else {
                        showNotification('error', '模板不存在');
                    }
                })
                .catch(error => {
                    console.error('載入模板失敗:', error);
                    showNotification('error', '載入模板失敗');
                });
        }
        
        // 保存為模板
        function saveAsTemplate() {
            const templateName = prompt('請輸入模板名稱：');
            if (templateName) {
                const formData = collectFormData();
                localStorage.setItem(`template_${templateName}`, JSON.stringify(formData));
                showNotification('success', `模板「${templateName}」已保存`);
            }
        }
        
        // 重置表單
        function resetForm() {
            if (confirm('確定要重置表單嗎？所有輸入的數據將會丟失。')) {
                document.getElementById('match-form').reset();
                showNotification('info', '表單已重置');
            }
        }
        
        // 預覽分析
        function previewAnalysis() {
            showNotification('info', '預覽功能開發中...');
        }
        
        // 收集表單數據
        function collectFormData() {
            const formData = {};
            const formElements = document.getElementById('match-form').elements;
            
            for (let element of formElements) {
                if (element.name) {
                    formData[element.name] = element.value;
                }
            }
            
            return formData;
        }
        
        // 表單提交處理
        document.getElementById('match-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 保存中...';
            submitBtn.disabled = true;
            
            try {
                const formData = collectFormData();
                
                // 構建奇門數據結構
                const qimenData = {
                    solar_date: formData.solar_date,
                    lunar_date: formData.lunar_date,
                    yang_dun: formData.yang_dun,
                    dun_number: parseInt(formData.dun_number),
                    four_pillars: formData.four_pillars,
                    kong_wang: formData.kong_wang,
                    horse_star: formData.horse_star,
                    value_symbol: formData.value_symbol,
                    value_door: formData.value_door,
                    asker_palace: formData.asker_palace,
                    palaces: {
                        dui: {
                            name: '兌宮',
                            direction: '西方',
                            four_harm: formData.dui_four_harm,
                            heavenly_stem: formData.dui_heavenly_stem,
                            sky_plate: formData.dui_sky_plate,
                            sky_plate_host: formData.dui_sky_plate_host,
                            ground_plate: formData.dui_ground_plate,
                            patterns: formData.dui_patterns,
                            eight_door: formData.dui_eight_door,
                            door_sky: formData.dui_door_sky,
                            nine_star: formData.dui_nine_star,
                            eight_god: formData.dui_eight_god
                        }
                        // 其他宮位...
                    }
                };
                
                // 構建比賽數據
                const matchData = {
                    match_code: formData.match_code,
                    home_team: formData.home_team,
                    away_team: formData.away_team,
                    competition_type: formData.competition_type,
                    match_time: formData.match_time,
                    timezone: formData.timezone,
                    status: 'pending',
                    qimen_data: qimenData,
                    created_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                };
                
                // 保存到Supabase
                const savedMatch = await window.supabaseClient.saveMatch(matchData);
                
                if (savedMatch) {
                    showNotification('success', '比賽數據保存成功！');
                    
                    // 執行AI分析
                    setTimeout(() => {
                        window.location.href = `analysis_view.html?match=${formData.match_code}`;
                    }, 1500);
                } else {
                    throw new Error('保存失敗');
                }
                
            } catch (error) {
                console.error('保存失敗:', error);
                showNotification('error', `保存失敗：${error.message}`);
            } finally {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });
        
        // 顯示通知
        function showNotification(type, message) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-content">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                </div>
                <button class="notification-close" onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            document.body.appendChild(notification);
            
            // 自動移除
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 設置默認時間為現在
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000).toISOString().slice(0, 16);
            document.getElementById('match_time').value = localDateTime;
            
            // 檢查URL參數
            const urlParams = new URLSearchParams(window.location.search);
            const template = urlParams.get('template');
            if (template) {
                loadTemplate(template);
            }
            
            // 移動端選單切換
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const navMenu = document.querySelector('.nav-menu');
            
            if (mobileMenuBtn) {
                mobileMenuBtn.addEventListener('click', () => {
                    navMenu.classList.toggle('active');
                });
            }
        });
    </script>
</body>
</html>