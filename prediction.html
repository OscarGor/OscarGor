<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>預測分析 - 己土奇門系統</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* 預測頁面專用樣式 */
        .prediction-hero {
            background: white;
            color: var(--first-color);
            padding: 30px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(34, 40, 49, 0.1);
            text-align: center;
        }
        
        .match-info h3 {
            font-size: var(--font-size-xl);
            color: var(--first-color);
            margin-bottom: 10px;
        }
        
        .match-info p {
            color: var(--second-color);
            font-size: var(--font-size-base);
        }
        
        .prediction-result {
            font-size: var(--font-size-3xl);
            font-weight: 800;
            margin: 20px 0;
            color: var(--third-color);
        }
        
        .confidence-meter {
            display: inline-block;
            background: rgba(249, 109, 0, 0.1);
            color: var(--third-color);
            padding: 8px 20px;
            border-radius: 20px;
            font-size: var(--font-size-base);
            font-weight: 600;
        }
        
        .detail-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
            margin: 25px 0;
        }
        
        @media (min-width: 992px) {
            .detail-grid {
                grid-template-columns: 1fr 1fr;
            }
        }
        
        .detail-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--shadow);
            border: 1px solid rgba(34, 40, 49, 0.1);
        }
        
        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(34, 40, 49, 0.1);
            align-items: center;
        }
        
        .detail-item:last-child {
            border-bottom: none;
        }
        
        .label {
            color: var(--first-color);
            font-weight: 600;
            font-size: var(--font-size-base);
        }
        
        .value {
            color: var(--third-color);
            font-weight: 700;
            font-size: var(--font-size-base);
        }
        
        .probability-chart {
            margin-top: 20px;
        }
        
        .prob-bar {
            margin-bottom: 15px;
        }
        
        .prob-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: var(--font-size-sm);
            color: var(--second-color);
        }
        
        .prob-meter {
            height: 12px;
            background: rgba(34, 40, 49, 0.1);
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .prob-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 1s ease-in-out;
        }
        
        .prob-value {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: var(--font-size-xs);
            font-weight: 700;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .qimen-diagram {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .diagram-cell {
            aspect-ratio: 1;
            border: 2px solid rgba(34, 40, 49, 0.1);
            border-radius: var(--border-radius-sm);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 10px;
            text-align: center;
            background: white;
            transition: all 0.3s ease;
        }
        
        .diagram-cell.active {
            border-color: var(--third-color);
            background: rgba(249, 109, 0, 0.05);
            transform: scale(1.05);
        }
        
        .diagram-cell.warning {
            border-color: #f39c12;
            background: rgba(243, 156, 18, 0.05);
        }
        
        .palace-name {
            font-weight: 700;
            margin-bottom: 5px;
            font-size: var(--font-size-sm);
            color: var(--first-color);
        }
        
        .palace-content {
            font-size: var(--font-size-xs);
            color: var(--second-color);
            margin-bottom: 3px;
        }
        
        .palace-detail {
            font-size: var(--font-size-xs);
            color: var(--third-color);
            font-weight: 600;
        }
        
        .palace-analysis {
            background: rgba(57, 62, 70, 0.03);
            border-left: 3px solid var(--third-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }
        
        .pattern-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: var(--border-radius-sm);
            border-left: 3px solid var(--third-color);
        }
        
        .pattern-item.good {
            border-left-color: var(--success-color);
        }
        
        .pattern-item.bad {
            border-left-color: var(--danger-color);
        }
        
        .analysis-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(34, 40, 49, 0.1);
        }
        
        .analysis-section:last-child {
            border-bottom: none;
        }
        
        .analysis-section h4 {
            color: var(--first-color);
            margin-bottom: 12px;
            font-size: var(--font-size-lg);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .analysis-section p {
            color: var(--second-color);
            line-height: 1.7;
            margin-bottom: 10px;
            font-size: var(--font-size-base);
        }
        
        .analysis-section ul {
            padding-left: 20px;
            color: var(--second-color);
        }
        
        .analysis-section li {
            margin-bottom: 8px;
            line-height: 1.6;
        }
        
        .action-section {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }
        
        .prediction-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        @media (max-width: 768px) {
            .prediction-stats {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .prediction-stats {
                grid-template-columns: 1fr;
            }
        }
        
        .prediction-stat {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: var(--border-radius);
            border: 1px solid rgba(34, 40, 49, 0.1);
        }
        
        .prediction-stat .stat-value {
            font-size: var(--font-size-2xl);
            font-weight: 800;
            color: var(--third-color);
            margin: 10px 0;
        }
        
        .prediction-stat .stat-label {
            font-size: var(--font-size-sm);
            color: var(--second-color);
            font-weight: 600;
        }
        
        .prediction-stat .stat-detail {
            font-size: var(--font-size-xs);
            color: var(--second-color);
            margin-top: 5px;
        }
        
        .ai-params-list {
            list-style: none;
            padding: 0;
        }
        
        .ai-params-list li {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(34, 40, 49, 0.1);
        }
        
        .ai-params-list li:last-child {
            border-bottom: none;
        }
        
        .param-name {
            color: var(--first-color);
            font-weight: 600;
        }
        
        .param-value {
            color: var(--third-color);
            font-weight: 700;
        }
        
        .dui-palace-details {
            background: rgba(231, 76, 60, 0.05);
            border-left: 3px solid #e74c3c;
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }
        
        .dui-palace-details h5 {
            color: #e74c3c;
            margin-bottom: 10px;
            font-size: var(--font-size-base);
        }
        
        .dui-palace-details ul {
            padding-left: 20px;
            color: var(--second-color);
        }
        
        .dui-palace-details li {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: var(--font-size-sm);
        }
        
        @media (max-width: 768px) {
            .action-section {
                flex-direction: column;
            }
            
            .btn-primary, .btn-secondary {
                width: 100%;
                justify-content: center;
            }
            
            .qimen-diagram {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .qimen-diagram {
                grid-template-columns: 1fr;
            }
            
            .prediction-result {
                font-size: var(--font-size-2xl);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="main-header">
            <div class="logo-section">
                <h1><i class="fas fa-chart-line"></i> 奇門足球預測分析</h1>
                <p class="version">FB3200 預測報告</p>
            </div>
            <nav class="main-nav">
                <a href="index.html"><i class="fas fa-home"></i> 輸入介面</a>
                <a href="prediction.html" class="active"><i class="fas fa-chart-line"></i> 當前預測</a>
                <a href="history.html"><i class="fas fa-history"></i> 歷史驗證</a>
                <a href="ai-params.html"><i class="fas fa-brain"></i> AI參數</a>
                <a href="lazy-commands.html"><i class="fas fa-terminal"></i> 指令包</a>
            </nav>
        </header>

        <main>
            <!-- 預測結果展示 -->
            <section class="prediction-hero">
                <div class="match-info">
                    <h3>馬德里CFF女足 vs 特內里費女足</h3>
                    <p>女子西班牙盃 | 2026年2月5日 02:00</p>
                </div>
                <div class="prediction-result" id="prediction-result">主勝</div>
                <div class="confidence-meter" id="confidence-meter">置信度：78%</div>
            </section>

            <!-- 預測統計 -->
            <div class="prediction-stats">
                <div class="prediction-stat">
                    <div class="stat-label">主勝概率</div>
                    <div class="stat-value" id="home-win-prob">65%</div>
                    <div class="stat-detail">離宮值符生門優勢</div>
                </div>
                
                <div class="prediction-stat">
                    <div class="stat-label">角球數</div>
                    <div class="stat-value" id="corner-prediction">5-3</div>
                    <div class="stat-detail">主隊 5 - 客隊 3</div>
                </div>
                
                <div class="prediction-stat">
                    <div class="stat-label">和局概率</div>
                    <div class="stat-value" id="draw-prob">20%</div>
                    <div class="stat-detail">值使門迫影響</div>
                </div>
                
                <div class="prediction-stat">
                    <div class="stat-label">總入球數</div>
                    <div class="stat-value" id="total-goals">2.5</div>
                    <div class="stat-detail">預測總入球數</div>
                </div>
                
                <div class="prediction-stat">
                    <div class="stat-label">客勝概率</div>
                    <div class="stat-value" id="away-win-prob">15%</div>
                    <div class="stat-detail">兌宮多重凶格</div>
                </div>
                
                <div class="prediction-stat">
                    <div class="stat-label">預測準確率</div>
                    <div class="stat-value" id="accuracy-rate">73.3%</div>
                    <div class="stat-detail">基於15場歷史數據</div>
                </div>
            </div>

            <div class="detail-grid">
                <!-- 左側：預測詳情 -->
                <div class="detail-card">
                    <h3><i class="fas fa-bullseye"></i> 詳細預測</h3>
                    
                    <div class="probability-chart">
                        <div class="prob-bar">
                            <div class="prob-label">
                                <span>主勝</span>
                                <span>65%</span>
                            </div>
                            <div class="prob-meter">
                                <div class="prob-fill" style="width: 65%; background: #27ae60;"></div>
                                <span class="prob-value">65%</span>
                            </div>
                        </div>
                        <div class="prob-bar">
                            <div class="prob-label">
                                <span>和局</span>
                                <span>20%</span>
                            </div>
                            <div class="prob-meter">
                                <div class="prob-fill" style="width: 20%; background: #f39c12;"></div>
                                <span class="prob-value">20%</span>
                            </div>
                        </div>
                        <div class="prob-bar">
                            <div class="prob-label">
                                <span>客勝</span>
                                <span>15%</span>
                            </div>
                            <div class="prob-meter">
                                <div class="prob-fill" style="width: 15%; background: #e74c3c;"></div>
                                <span class="prob-value">15%</span>
                            </div>
                        </div>
                    </div>

                    <div class="detail-item">
                        <span class="label">比賽結果：</span>
                        <span class="value" id="detail-result">主隊獲勝</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">角球預測：</span>
                        <span class="value" id="detail-corners">主隊 5 - 3 客隊</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">總入球數：</span>
                        <span class="value" id="detail-total-goals">2.5球</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">讓球建議：</span>
                        <span class="value" id="detail-handicap">主隊讓0.5球</span>
                    </div>
                    <div class="detail-item">
                        <span class="label">大小球建議：</span>
                        <span class="value" id="detail-overunder">2.5球以下</span>
                    </div>
                </div>

                <!-- 右側：奇門分析 -->
                <div class="detail-card">
                    <h3><i class="fas fa-yin-yang"></i> 奇門格局分析</h3>
                    
                    <div class="qimen-diagram">
                        <!-- 奇門九宮圖 -->
                        <div class="diagram-cell active">
                            <div class="palace-name">離宮</div>
                            <div class="palace-content">己+丁</div>
                            <div class="palace-detail">生門 天輔</div>
                            <div style="font-size: 0.7rem; color: #27ae60; margin-top: 3px;">
                                主隊
                            </div>
                        </div>
                        <div class="diagram-cell">
                            <div class="palace-name">坤宮</div>
                            <div class="palace-content">-</div>
                        </div>
                        <div class="diagram-cell warning">
                            <div class="palace-name">兌宮</div>
                            <div class="palace-content">乙+壬 (庚寄)</div>
                            <div class="palace-detail">杜門 天芮</div>
                            <div style="font-size: 0.7rem; color: #e74c3c; margin-top: 3px;">
                                空亡
                            </div>
                        </div>
                        <div class="diagram-cell">
                            <div class="palace-name">巽宮</div>
                            <div class="palace-content">戊+己</div>
                            <div class="palace-detail">休門 天沖</div>
                        </div>
                        <div class="diagram-cell">
                            <div class="palace-name">中宮</div>
                            <div class="palace-content">-</div>
                        </div>
                        <div class="diagram-cell">
                            <div class="palace-name">乾宮</div>
                            <div class="palace-content">壬+辛</div>
                            <div class="palace-detail">景門 天柱</div>
                        </div>
                        <div class="diagram-cell">
                            <div class="palace-name">震宮</div>
                            <div class="palace-content">癸+戊</div>
                            <div class="palace-detail">開門 天任</div>
                        </div>
                        <div class="diagram-cell">
                            <div class="palace-name">艮宮</div>
                            <div class="palace-content">丙+癸</div>
                            <div class="palace-detail">驚門 天蓬</div>
                        </div>
                        <div class="diagram-cell">
                            <div class="palace-name">坎宮</div>
                            <div class="palace-content">辛+丙</div>
                            <div class="palace-detail">死門 天心</div>
                        </div>
                    </div>

                    <div class="palace-analysis">
                        <h4>關鍵格局解讀</h4>
                        <div class="pattern-item good">
                            <strong>主隊優勢：</strong> 離宮生門天輔值符，得地利貴人扶持
                        </div>
                        <div class="pattern-item bad">
                            <strong>客隊劣勢：</strong> 兌宮空亡杜門天芮，狀態不佳進攻受阻
                        </div>
                        <div class="pattern-item good">
                            <strong>五行生克：</strong> 離火克兌金，主隊克制客隊
                        </div>
                        <div class="pattern-item bad">
                            <strong>四害影響：</strong> 客隊宮位空亡，主隊無四害
                        </div>
                    </div>
                </div>
            </div>

            <!-- 詳細分析報告 -->
            <section class="card">
                <h3><i class="fas fa-microscope"></i> 詳細分析報告</h3>
                
                <div class="analysis-section">
                    <h4><i class="fas fa-chart-pie"></i> 一、賽果概率分析</h4>
                    <p>基於奇門遁甲格局分析，主隊獲勝概率為<strong>65%</strong>，和局概率<strong>20%</strong>，客隊獲勝概率僅<strong>15%</strong>。</p>
                    <p><strong>主要依據：</strong></p>
                    <ul>
                        <li>離宮值符天輔星配合生門，主隊得地利人和</li>
                        <li>兌宮空亡且逢杜門天芮，客隊狀態低迷</li>
                        <li>離火克兌金的五行生克關係，主隊克制客隊</li>
                        <li>值符值使關係顯示主隊佔據主動權</li>
                    </ul>
                </div>
                
                <div class="analysis-section">
                    <h4><i class="fas fa-futbol"></i> 二、角球數預測分析</h4>
                    <p>預測角球數：<strong>主隊5個，客隊3個</strong>，總角球數8個。</p>
                    <p><strong>分析依據：</strong></p>
                    <ul>
                        <li>景門在乾宮門迫，顯示角球爭奪激烈但效率不高</li>
                        <li>離宮生門有利主隊創造角球機會</li>
                        <li>兌宮空亡減少客隊角球機會</li>
                        <li>驚門在艮宮，客隊防守可能出現失誤送角球</li>
                    </ul>
                </div>
                
                <div class="analysis-section">
                    <h4><i class="fas fa-bullseye"></i> 三、總入球數分析</h4>
                    <p>預測總入球數：<strong>2.5球</strong>（傾向於2-3球之間）。</p>
                    <p><strong>關鍵因素：</strong></p>
                    <ul>
                        <li>生門在離宮，主隊進攻有條理，但朱雀入墓顯示戰術或有小失誤</li>
                        <li>杜門在兌宮空亡，客隊進攻受阻，難有太多射門機會</li>
                        <li>死門在坎宮門迫，雙方防守均有壓力但能守住大部分攻勢</li>
                        <li>開門在震宮門迫擊刑，可能出現意外失球</li>
                    </ul>
                </div>
                
                <!-- 兌宮深度分析 -->
                <div class="analysis-section">
                    <h4><i class="fas fa-exclamation-triangle"></i> 四、兌宮（客隊）深度分析</h4>
                    <p><strong>核心問題：</strong> 兌宮出現多重凶格組合，客隊狀態極差</p>
                    
                    <div class="dui-palace-details">
                        <h5>兌宮詳細格局分析：</h5>
                        <ul>
                            <li><strong>四害：空亡</strong>（深挖到坎宮）- 客隊實力無法發揮，狀態空虛</li>
                            <li><strong>天盤乙 + 天盤寄宮庚：</strong> 日奇被刑 - 客隊內部不和，執行力差</li>
                            <li><strong>天盤乙 + 地盤壬：</strong> 日奇入地 - 客隊奇兵戰術無效，計劃落空</li>
                            <li><strong>天盤寄宮庚 + 地盤壬：</strong> 小格（移蕩格）- 客隊陣容不穩，人員變動頻繁</li>
                            <li><strong>八門+天盤：杜 + 乙</strong> - 飛來橫禍（訴訟）- 客隊可能遭遇意外挫折或爭議判罰</li>
                            <li><strong>九星：天芮星</strong> - 病星，客隊可能有傷病情況或狀態不佳</li>
                            <li><strong>八神：太陰</strong> - 隱藏問題，客隊有未公開的內部問題</li>
                            <li><strong>乙天干臨：絕位</strong> - 客隊運勢處於最低點</li>
                            <li><strong>庚天干臨：帝旺位</strong> - 寄宮庚帝旺，但被刑，顯示客隊有實力但被壓制</li>
                        </ul>
                    </div>
                    
                    <p><strong>AI評估：</strong> 兌宮出現如此密集的凶格組合在歷史數據中僅佔5%，此格局下客隊獲勝概率極低（<15%）。</p>
                </div>
                
                <div class="analysis-section">
                    <h4><i class="fas fa-brain"></i> 五、AI參數應用分析</h4>
                    <p>本次預測應用了優化後的AI參數權重：</p>
                    <ul class="ai-params-list">
                        <li>
                            <span class="param-name">宮位強度權重：</span>
                            <span class="param-value">35%</span>
                        </li>
                        <li>
                            <span class="param-name">用神關係權重：</span>
                            <span class="param-value">25%</span>
                        </li>
                        <li>
                            <span class="param-name">時空因素權重：</span>
                            <span class="param-value">15%</span>
                        </li>
                        <li>
                            <span class="param-name">格局分析權重：</span>
                            <span class="param-value">15%</span>
                        </li>
                        <li>
                            <span class="param-name">球隊狀態權重：</span>
                            <span class="param-value">10%</span>
                        </li>
                    </ul>
                    <p><em>基於歷史數據庫分析：</em></p>
                    <ul>
                        <li>「離火克兌金」格局準確率達72%</li>
                        <li>「值符+生門」組合準確率達68%</li>
                        <li>「兌宮空亡+杜門」組合準確率達75%</li>
                        <li>「日奇被刑+日奇入地」雙重凶格準確率達80%</li>
                    </ul>
                </div>
            </section>

            <!-- 行動按鈕 -->
            <div class="action-section">
                <button class="btn-primary" onclick="savePrediction()">
                    <i class="fas fa-save"></i> 保存預測報告
                </button>
                <button class="btn-secondary" onclick="recordResult()">
                    <i class="fas fa-clipboard-check"></i> 輸入比賽結果
                </button>
                <button class="btn-secondary" onclick="viewHistory()">
                    <i class="fas fa-history"></i> 查看歷史驗證
                </button>
            </div>
        </main>

        <footer class="main-footer">
            <p>己土玄學顧問公司 © 2026 | 預測報告僅供參考</p>
            <p class="disclaimer">系統版本：1.1 | 預測時間：<span id="prediction-time"></span></p>
        </footer>
    </div>

    <!-- 結果輸入模態框 -->
    <div id="result-modal" class="modal">
        <div class="modal-content" style="text-align: left; max-width: 500px;">
            <span class="close-modal" onclick="closeResultModal()">&times;</span>
            <h3>輸入比賽結果</h3>
            <form id="result-form">
                <div class="form-group">
                    <label>最終比分</label>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <input type="number" id="home-score" min="0" max="20" placeholder="主隊" style="width: 80px;">
                        <span> - </span>
                        <input type="number" id="away-score" min="0" max="20" placeholder="客隊" style="width: 80px;">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>主隊角球數</label>
                        <input type="number" id="home-corners" min="0" max="30" placeholder="例如：5">
                    </div>
                    <div class="form-group">
                        <label>客隊角球數</label>
                        <input type="number" id="away-corners" min="0" max="30" placeholder="例如：3">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>比賽備註</label>
                    <textarea id="match-notes" rows="3" placeholder="可記錄比賽特殊情況..."></textarea>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-primary" onclick="submitResult()">
                        提交結果
                    </button>
                    <button type="button" class="btn-secondary" onclick="closeResultModal()">
                        取消
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 頁面加載完成後初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('預測分析頁面已加載');
            loadPredictionData();
        });
        
        // 加載預測數據
        function loadPredictionData() {
            const prediction = JSON.parse(localStorage.getItem('currentPrediction'));
            
            if (prediction && prediction.predictions) {
                const pred = prediction.predictions;
                
                // 更新頁面內容
                document.getElementById('prediction-result').textContent = pred.homeWin >= 50 ? '主勝' : 
                                                                         pred.awayWin >= 50 ? '客勝' : '和局';
                document.getElementById('confidence-meter').textContent = `置信度：${pred.confidence || 78}%`;
                
                document.getElementById('home-win-prob').textContent = `${pred.homeWin || 65}%`;
                document.getElementById('draw-prob').textContent = `${pred.draw || 20}%`;
                document.getElementById('away-win-prob').textContent = `${pred.awayWin || 15}%`;
                
                if (pred.corners) {
                    document.getElementById('corner-prediction').textContent = 
                        `${pred.corners.home || 5}-${pred.corners.away || 3}`;
                    document.getElementById('detail-corners').textContent = 
                        `主隊 ${pred.corners.home || 5} - ${pred.corners.away || 3} 客隊`;
                }
                
                document.getElementById('total-goals').textContent = pred.totalGoals || '2.5';
                document.getElementById('detail-total-goals').textContent = `${pred.totalGoals || 2.5}球`;
                
                // 根據預測設置顏色
                const result = document.getElementById('prediction-result').textContent;
                const resultElement = document.getElementById('prediction-result');
                
                if (result.includes('主勝')) {
                    resultElement.style.color = '#27ae60';
                } else if (result.includes('客勝')) {
                    resultElement.style.color = '#e74c3c';
                } else {
                    resultElement.style.color = '#f39c12';
                }
            }
            
            // 設置預測時間
            document.getElementById('prediction-time').textContent = 
                prediction ? new Date(prediction.timestamp).toLocaleString('zh-Hant') : new Date().toLocaleString('zh-Hant');
                
            // 加載準確率數據
            loadAccuracyData();
        }
        
        // 加載準確率數據
        function loadAccuracyData() {
            const history = JSON.parse(localStorage.getItem('qimenMatchHistory') || '[]');
            const verified = history.filter(m => m.actualResult?.verified);
            
            if (verified.length > 0) {
                const totalAccuracy = verified.reduce((sum, m) => sum + (m.aiLearning?.accuracy || 0), 0);
                const avgAccuracy = Math.round(totalAccuracy / verified.length * 10) / 10;
                document.getElementById('accuracy-rate').textContent = `${avgAccuracy}%`;
            }
        }
        
        // 保存預測報告
        function savePrediction() {
            const prediction = JSON.parse(localStorage.getItem('currentPrediction') || '{}');
            const dataStr = JSON.stringify(prediction, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `奇門預測_${prediction.matchId || 'FB3200'}_報告.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('預測報告已保存！');
        }
        
        // 記錄比賽結果
        function recordResult() {
            document.getElementById('result-modal').style.display = 'flex';
        }
        
        // 關閉結果模態框
        function closeResultModal() {
            document.getElementById('result-modal').style.display = 'none';
        }
        
        // 提交比賽結果
        function submitResult() {
            const homeScore = document.getElementById('home-score').value;
            const awayScore = document.getElementById('away-score').value;
            const homeCorners = document.getElementById('home-corners').value;
            const awayCorners = document.getElementById('away-corners').value;
            const notes = document.getElementById('match-notes').value;
            
            if (!homeScore || !awayScore) {
                alert('請輸入完整的比分！');
                return;
            }
            
            const result = {
                finalScore: `${homeScore}-${awayScore}`,
                corners: {
                    home: parseInt(homeCorners) || 0,
                    away: parseInt(awayCorners) || 0
                },
                notes: notes,
                verified: true,
                verifiedAt: new Date().toISOString()
            };
            
            // 保存結果到當前預測
            let currentPrediction = JSON.parse(localStorage.getItem('currentPrediction') || '{}');
            currentPrediction.actualResult = result;
            localStorage.setItem('currentPrediction', JSON.stringify(currentPrediction));
            
            // 保存到歷史記錄
            let history = JSON.parse(localStorage.getItem('qimenMatchHistory') || '[]');
            const matchId = currentPrediction.matchId || 'FB3200';
            
            // 查找並更新歷史記錄
            const matchIndex = history.findIndex(m => m.matchId === matchId);
            if (matchIndex !== -1) {
                history[matchIndex].actualResult = result;
            } else {
                // 如果沒有找到，創建新記錄
                const matchData = {
                    matchId: matchId,
                    matchTime: currentPrediction.matchTime || '2026年2月5日 02:00',
                    homeTeam: currentPrediction.homeTeam || '馬德里CFF女足',
                    awayTeam: currentPrediction.awayTeam || '特內里費女足',
                    competition: currentPrediction.competition || '女子西班牙盃',
                    predictions: currentPrediction.predictions || {},
                    actualResult: result,
                    timestamp: new Date().toISOString()
                };
                history.push(matchData);
            }
            
            localStorage.setItem('qimenMatchHistory', JSON.stringify(history));
            
            closeResultModal();
            alert('比賽結果已保存！系統將開始AI學習分析。');
            
            // 重新加載準確率數據
            loadAccuracyData();
        }
        
        // 查看歷史
        function viewHistory() {
            window.location.href = 'history.html';
        }
        
        // 全局函數導出
        window.savePrediction = savePrediction;
        window.recordResult = recordResult;
        window.viewHistory = viewHistory;
        window.closeResultModal = closeResultModal;
        window.submitResult = submitResult;
    </script>
</body>
</html>